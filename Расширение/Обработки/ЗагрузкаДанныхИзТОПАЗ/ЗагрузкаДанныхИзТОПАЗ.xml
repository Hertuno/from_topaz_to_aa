<?xml version="1.0" encoding="UTF-8"?>
<MetaDataObject xmlns="http://v8.1c.ru/8.3/MDClasses" xmlns:app="http://v8.1c.ru/8.2/managed-application/core" xmlns:cfg="http://v8.1c.ru/8.1/data/enterprise/current-config" xmlns:cmi="http://v8.1c.ru/8.2/managed-application/cmi" xmlns:ent="http://v8.1c.ru/8.1/data/enterprise" xmlns:lf="http://v8.1c.ru/8.2/managed-application/logform" xmlns:style="http://v8.1c.ru/8.1/data/ui/style" xmlns:sys="http://v8.1c.ru/8.1/data/ui" xmlns:v8="http://v8.1c.ru/8.1/data/core" xmlns:v8ui="http://v8.1c.ru/8.1/data/ui" xmlns:web="http://v8.1c.ru/8.1/data/ui/colors" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="2.12">
	<DataProcessor uuid="c1d2e3f4-a5b6-4789-c012-d3e4f5a6b789">
		<Properties>
			<Name>ЗагрузкаДанныхИзТОПАЗ</Name>
			<Synonym>
				<Key>ru</Key>
				<Value>Загрузка данных из ТОПАЗ</Value>
			</Synonym>
			<Comment>Обработка для автоматизированной загрузки данных о реализации топлива из системы ТОПАЗ</Comment>
			<Help>Обработка для автоматизированной загрузки данных о реализации топлива из XML файлов системы ТОПАЗ с формированием документов учета</Help>
			<DataLockControlMode>Managed</DataLockControlMode>
			<FullTextSearch>DontUse</FullTextSearch>
		</Properties>
		<ChildObjects>
			<ObjectModule uuid="a1b2c3d4-e5f6-4789-a012-b3c4d5e6f012">
				<Properties>
					<Name>МодульОбъекта</Name>
					<Synonym>
						<Key>ru</Key>
						<Value>Модуль объекта</Value>
					</Synonym>
					<Source>
						<Text>#Область СлужебныйПрограммныйИнтерфейс

// Выполняет загрузку данных из XML файлов ТОПАЗ
//
Процедура ВыполнитьЗагрузку() Экспорт
	
	Попытка
		
		Настройки = ЗагрузкаТОПАЗОбщий.ПолучитьНастройки();
		
		Если Настройки.Количество() = 0 Тогда
			ВызватьИсключение "Настройки загрузки не заполнены. Заполните регистр сведений НастройкиЗагрузкиТОПАЗ.";
		КонецЕсли;
		
		КаталогЗагрузки = Настройки.КаталогЗагрузки;
		
		Если ПустаяСтрока(КаталогЗагрузки) Тогда
			ВызватьИсключение "Не указан каталог загрузки в настройках.";
		КонецЕсли;
		
		Если Не КаталогСуществует(КаталогЗагрузки) Тогда
			ВызватьИсключение "Каталог загрузки не существует: " + КаталогЗагрузки;
		КонецЕсли;
		
		// Поиск XML файлов за текущие сутки
		ТекущаяДата = ТекущаяДата();
		НачалоСуток = НачалоДня(ТекущаяДата);
		КонецСуток = КонецДня(ТекущаяДата);
		
		МаскаФайла = "CloseSession_*.xml";
		НайденныеФайлы = НайтиФайлы(КаталогЗагрузки, МаскаФайла);
		
		ОбработанныеФайлы = 0;
		Ошибки = Новый Массив;
		
		Для Каждого ПутьКФайлу Из НайденныеФайлы Цикл
			
			Попытка
				
				ДатаФайла = ПолучитьДатуИзмененияФайла(ПутьКФайлу);
				
				// Обрабатываем только файлы за текущие сутки
				Если ДатаФайла >= НачалоСуток И ДатаФайла <= КонецСуток Тогда
					
					ОбработатьФайл(ПутьКФайлу, Настройки);
					ОбработанныеФайлы = ОбработанныеФайлы + 1;
					
					ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
						УровеньЖурналаРегистрации.Информация, , , 
						"Файл успешно обработан: " + ПутьКФайлу);
					
				КонецЕсли;
				
			Исключение
				
				ТекстОшибки = ОписаниеОшибки();
				Ошибки.Добавить("Ошибка при обработке файла " + ПутьКФайлу + ": " + ТекстОшибки);
				
				ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
					УровеньЖурналаРегистрации.Ошибка, , , 
					"Ошибка при обработке файла " + ПутьКФайлу + ": " + ТекстОшибки);
				
			КонецПопытки;
			
		КонецЦикла;
		
		// Проверка последнего дня месяца
		Если День(КонецМесяца(ТекущаяДата)) = День(ТекущаяДата) Тогда
			
			Попытка
				ОбработатьПоследнийДеньМесяца(Настройки);
			Исключение
				ТекстОшибки = ОписаниеОшибки();
				Ошибки.Добавить("Ошибка при обработке последнего дня месяца: " + ТекстОшибки);
				
				ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
					УровеньЖурналаРегистрации.Ошибка, , , 
					"Ошибка при обработке последнего дня месяца: " + ТекстОшибки);
			КонецПопытки;
			
		КонецЕсли;
		
		ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
			УровеньЖурналаРегистрации.Информация, , , 
			"Загрузка завершена. Обработано файлов: " + ОбработанныеФайлы);
		
	Исключение
		
		ТекстОшибки = ОписаниеОшибки();
		ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
			УровеньЖурналаРегистрации.Ошибка, , , 
			"Критическая ошибка при выполнении загрузки: " + ТекстОшибки);
		
		ВызватьИсключение ТекстОшибки;
		
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти</Text>
					</Source>
				</Properties>
			</ObjectModule>
		</ChildObjects>
	</DataProcessor>
</MetaDataObject>

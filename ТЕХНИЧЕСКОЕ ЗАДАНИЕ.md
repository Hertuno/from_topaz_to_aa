ТЕХНИЧЕСКОЕ ЗАДАНИЕ
на разработку расширения конфигурации "1С:Альфа-Авто 6.1"
для автоматизированной загрузки данных из системы ТОПАЗ

1. ОБЩИЕ ПОЛОЖЕНИЯ

1.1. Назначение
    Расширение предназначено для автоматизированной загрузки данных о реализации топлива 
    из программы АЗС ТОПАЗ в систему 1С:Альфа-Авто 6.1 с последующим формированием 
    необходимых документов учета.

1.2. Основание для разработки
    Необходимость автоматизации ежедневной загрузки данных о реализации топлива 
    с различными способами оплаты (наличный, безналичный расчет, топливные карты).

1.3. Область применения
    Расширение будет использоваться для АЗС, работающих на программном обеспечении ТОПАЗ,
    с учетом в системе 1С:Альфа-Авто 6.1.


2. ТРЕБОВАНИЯ К ФУНКЦИОНАЛЬНОСТИ

2.1. Общие требования

2.1.1. Режим работы
    - Автоматический запуск: ежедневно в 23:50
    - [Возможность ручного запуска загрузки]
    - [Логирование всех операций загрузки]

2.1.2. Источник данных
    - Формат файла: XML
    - Имя файла: CloseSession_ГГГГ-ММ-ДД_ЧЧ-ММ-СС.xml
    - Кодировка: windows-1251
    - Структура: согласно формату выгрузки ТОПАЗ версии 3.15

2.1.3. Каталог загрузки файлов
    - Путь к каталогу должен быть настраиваемым
    - [Обработка всех необработанных файлов за текущие сутки]


2.2. Структура входных данных (XML)

2.2.1. Корневой элемент DataPaket
    Атрибуты:
    - Version: версия формата (например, "3.15")
    - DateTime: дата и время выгрузки
    - Type: тип пакета (например, "Aggregated")
    - AZSCode: код АЗС

2.2.2. Элемент Session
    Атрибуты:
    - SessionNum: номер смены
    - StartDateTime: начало смены
    - EndDateTime: окончание смены
    - UserName: имя пользователя (оператора)

2.2.3. Типы операций реализации

    A. OutcomeByRetail (Розничная продажа за наличный расчет)
       Атрибуты элемента:
       - TankNum: номер резервуара
       - HoseName: номер колонки/рукава
       - FuelName: наименование топлива (например, "КПГ")
       - PaymentModeName: способ оплаты (фильтр: НЕ "Топливная карта")
       - Volume: объем в литрах (м³ для газа)
       - Amount: сумма с НДС
       - OrigPrice: цена за единицу
       - AmountCash: сумма наличными
       - AmountCashless: сумма безналичными (карты оплаты)
       - OrderCount: количество заправок
       - Date, Time: могут отсутствовать (берем из Session)

    B. OutcomeByOffice (Продажа по топливной карте)
       Атрибуты элемента:
       - Date: дата операции
       - Time: время операции
       - TankNum: номер резервуара
       - HoseName: номер колонки/рукава
       - FuelName: наименование топлива
       - PaymentModeName: способ оплаты (должно быть "Топливная карта")
       - Volume: объем в литрах (м³ для газа)
       - Amount: сумма с НДС
       - OrigPrice: цена за единицу
       - AmountTotal: общая сумма

       Дочерние элементы:
       - CardCode: код топливной карты
       - PartnerName: наименование контрагента
       - PartnerINN: ИНН контрагента
       - LimitCard_CarName: марка автомобиля
       - LimitCard_CarNumber: госномер автомобиля
       - Schema (атрибут Type): тип схемы


2.3. Алгоритм обработки данных

2.3.1. Общий алгоритм загрузки
    1. Проверка наличия необработанных файлов в каталоге загрузки
    2. Чтение и валидация XML-файла
    3. Извлечение данных о сессии (смене)
    4. Обработка операций реализации согласно типу оплаты
    5. Формирование документов 1С
    6. Проведение документов
    7. Запись в журнал регистрации

2.3.2. Определение типа операции

    Критерии определения типа оплаты:

    A. НАЛИЧНЫЙ/БЕЗНАЛИЧНЫЙ РАСЧЕТ (физическое лицо)
       Источник: OutcomeByRetail
       Условие: PaymentModeName <> "Топливная карта" ИЛИ OfficeCardCode = пусто
       Признаки:
       - Отсутствует PartnerINN
       - Может быть AmountCash > 0 (наличка) или AmountCashless > 0 (терминал)

    B. ОПЛАТА ТОПЛИВНОЙ КАРТОЙ (юридическое лицо)
       Источник: OutcomeByOffice
       Условие: PaymentModeName = "Топливная карта" И заполнен PartnerINN
       Признаки:
       - Присутствует PartnerINN
       - Присутствует CardCode
       - Присутствует PartnerName


2.4. Формирование документов для НАЛИЧНОГО/БЕЗНАЛИЧНОГО РАСЧЕТА

Для каждого типа оплаты PaymentModeName из блока OutcomesByRetail (кроме “Топливная карта”) создается связка Реализация товаров + Чек на оплату + Счет фактура выданный
Документ “Инкассация” создается один на все оплаты
Документ “Приходный кассовый ордер” создается только на “Наличный расчет”

2.4.1. Документ "Реализация товаров" (Документ.РеализацияТоваров)

    Шапка документа:
    - Дата: дата файла обмена + время 23:50
    - Номер: автоматический
    - Контрагент: справочник "Контрагенты" -> "Частное Лицо"
    - ДоговорВзаиморасчетов: договор по умолчанию для розницы (настраивается)
    - Организация: из настроек (например, "Авангард")
    - ПодразделениеКомпании: из настроек (например, "Авангард")
    - СкладКомпании: из настроек (например, "КПГ")
    - ВалютаДокумента: RUB
    - КурсДокумента: 1
    - ХозОперация: "Реализация товаров"
    - РегламентированныйУчет: Да
    - ЭтоУниверсальныйДокумент: Да
    - СпособЗачетаАвансов: "Не зачитывать"
    - ТипЦен: из настроек (например, "Основной тип цен продажи")
    - Менеджер: робот регламентных операций

    Табличная часть "Товары":
    - Номенклатура: из настроек
    - Количество: из атрибута Volume
    - Цена: из атрибута OrigPrice
    - Сумма: из атрибута Amount
    - СтавкаНДС: 20%
    - СуммаНДС: рассчитать от суммы
    - СуммаСНДС: = Сумма

2.4.2. Документ "Чек на оплату" (Документ.ЧекНаОплату)

    Создается на основании документа "Реализация товаров"

    Шапка документа:
    - Дата: = дата документа "Реализация товаров"
    - Номер: автоматический
    - ДокументОснование: ссылка на "Реализация товаров"
    - Контрагент: = из документа основания
    - ДоговорВзаиморасчетов: = из документа основания
    - Организация: = из документа основания
    - ПодразделениеКомпании: = из документа основания
    - КассаККМ: из настроек (например, "Касса Авангард")
    - ВалютаДокумента: RUB
    - ХозОперация: "Чек на оплату"
    - РегламентированныйУчет: Да
    - СтавкаНДС: 20%
    - БлокироватьПерерасчетСкидок: Да
    - ПризнакСпособаРасчета: "Передача с полной оплатой"
    - Сделка: ссылка на документ "Реализация товаров"

    Табличная часть "Товары":
    - Копируется из документа "Реализация товаров"
    - Номенклатура: = из основания
    - Количество: = из основания
    - Цена: = из основания
    - Сумма: = из основания
    - СтавкаНДС: = из основания
    - СуммаНДС: = из основания

    Табличная часть "Оплаты":
    - СпособОплаты: определить по соотношению AmountCash / AmountCashless
      * Если AmountCash > 0 -> "Наличными"
      * Если AmountCashless > 0 -> "Платежной картой" (через терминал)
    - Сумма: соответствующая сумма из XML
    - СчетУчета: определяется автоматически по способу оплаты

2.4.3. Документ "Инкассация" (Документ.Инкассация)

    Создается на основании документа "Чек на оплату"

    Шапка документа:
    - Дата: = дата документа "Чек на оплату"
    - Номер: автоматический
    - ДокументОснование: ссылка на "Чек на оплату" (может быть пустым)
    - Организация: = из документа основания
    - ПодразделениеКомпании: = из документа основания
    - КассаККМ: = из документа основания
    - ВалютаДокумента: RUB
    - СуммаДокумента: = сумма из документа "Чек на оплату"
    - ХозОперация: "Изъятие из кассы ККМ"
    - Инкассатор: из настроек (например, текущий сотрудник)
    - ДоговорВзаиморасчетовИнкассатор: из настроек (например, "Инкассация АВ в RUB")
    - ПлатежнаяСистема: из настроек для безналичных платежей (например, "БАНК РУССКИЙ СТАНДАРТ АО")
    - ДоговорВзаиморасчетовПлатежнаяСистема: из настроек (например, "Терминал АВ")

    Табличная часть "Оплаты":
    - Копируется структура оплат из документа "Чек на оплату"

2.4.4. Документ "Приходный кассовый ордер" (Документ.ПриходныйКассовыйОрдер)

    Создается на основании документа "Инкассация"

    Шапка документа:
    - Дата: = дата документа "Инкассация"
    - Номер: автоматический
    - ДокументОснование: ссылка на "Инкассация"
    - Организация: = из документа основания
    - ПодразделениеКомпании: = из документа основания
    - КассаКомпании: главная касса компании (настраивается, например, "Касса (RUB)")
    - ВалютаДокумента: RUB
    - СуммаДокумента: = сумма из документа "Инкассация"
    - ХозОперация: "Инкассация из кассы ККМ"
    - РегламентированныйУчет: Да
    - Контрагент: = Инкассатор из документа "Инкассация"
    - ДоговорВзаиморасчетов: договор инкассации
    - СтатьяДвиженияДенежныхСредств: из настроек
    - ВидОперации: "Инкассация"
    - Принято от: текст - наименование инкассатора
    - Основание: текст - "Инкассация из кассы ККМ"

2.4.5. Документ "Счет-фактура выданный" (Документ.СчетФактураВыданный)

    Создается на основании документа "Реализация товаров"

    Шапка документа:
    - Дата: = дата документа "Реализация товаров"
    - Номер: автоматический
    - ДокументОснование: ссылка на "Реализация товаров"
    - Контрагент: = из документа основания
    - ДоговорВзаиморасчетов: = из документа основания
    - Организация: = из документа основания
    - ПодразделениеКомпании: = из документа основания
    - ВалютаДокумента: RUB
    - ВидСчетаФактуры: "На реализацию"
    - РегламентированныйУчет: Да

    Табличная часть "Товары":
    - Копируется из документа "Реализация товаров"
    - Рассчитываются суммы НДС


2.5. Формирование документов для ОПЛАТЫ ТОПЛИВНОЙ КАРТОЙ

Для типа оплаты “Топливная карта” из блока OutcomeByOffice :

2.5.1. Документ "Реализация товаров" (Документ.РеализацияТоваров)

    Шапка документа:
    - Дата: дата файла обмена + время 23:50
    - Номер: автоматический
    - Контрагент: найти по ИНН из PartnerINN (справочник "Контрагенты")
    - ДоговорВзаиморасчетов: найти существующий договор с контрагентом
    - Организация: из настроек
    - ПодразделениеКомпании: из настроек
    - СкладКомпании: из настроек
    - ВалютаДокумента: RUB
    - ХозОперация: "Реализация товаров"
    - РегламентированныйУчет: Да
    - СпособЗачетаАвансов: "Не зачитывать"
    - ТипЦен: из настроек
    - Менеджер: из настроек
    - [Комментарий: сформировать текст вида "Топливная карта: [CardCode], Автомобиль: [LimitCard_CarName] [LimitCard_CarNumber]"]

    Табличная часть "Товары":
    - Номенклатура: найти по FuelName
    - Количество: из атрибута Volume
    - Цена: из атрибута OrigPrice
    - Сумма: из атрибута Amount
    - СтавкаНДС: определить по номенклатуре
    - СуммаНДС: рассчитать
    - СуммаСНДС: = Сумма

2.5.2. Документ "Счет-фактура выданный" (Документ.СчетФактураВыданный)

    Создается на основании документа "Реализация товаров"

    Структура аналогична п. 2.4.5, но:
    - Контрагент: юридическое лицо (из PartnerName)
    - Заполняются все обязательные реквизиты для юр.лица


2.6. Особые правила для последнего дня месяца

2.6.1. Условие срабатывания
    Если дата загрузки = последний день месяца

2.6.2. Дополнительные действия для операций по топливным картам

    Для каждого контрагента (кроме "Частное Лицо"), который имел операции 
    по топливным картам в текущем месяце:

    A. Создать итоговый документ "Реализация товаров":
       - Дата: последний день месяца, 23:59
       - Контрагент: юридическое лицо
       - Табличная часть "Товары": 
         * По каждому виду топлива - суммарное количество за месяц
         * Цена - средневзвешенная за месяц
         * Сумма - итоговая за месяц
       - [Комментарий: "Итоговая реализация за [месяц] [год]"]

    B. Создать итоговый "Счет-фактура выданный" на основании итогового документа

    C. Пометить на удаление:
       - Все ранее созданные за месяц документы "Реализация товаров" по топливным картам 
       - Все соответствующие документы "Счет-фактура выданный"

    Примечание: Документы помечаются на удаление, но не удаляются физически, 
    для возможности восстановления данных.


2.7. Справочники и настройки

2.7.1. Регистр сведений "НастройкиЗагрузкиТОПАЗ" (новый)

    Реквизиты:
    - Организация: СправочникСсылка.Организации
    - ПодразделениеКомпании: СправочникСсылка.ПодразделенияКомпании
    - СкладКомпании: СправочникСсылка.СкладыКомпании
    - КассаККМ: СправочникСсылка.КассыККМ
    - КассаКомпании: СправочникСсылка.КассыКомпании (главная касса)
    - ДоговорРозничныйПоУмолчанию: СправочникСсылка.ДоговорыВзаиморасчетов
    - ТипЦен: СправочникСсылка.ТипыЦен
    - МенеджерПоУмолчанию: СправочникСсылка.Сотрудники
    - Инкассатор: СправочникСсылка.Контрагенты
    - ДоговорИнкассации: СправочникСсылка.ДоговорыВзаиморасчетов
    - ПлатежнаяСистема: СправочникСсылка.Контрагенты (для терминала)
    - ДоговорПлатежнойСистемы: СправочникСсылка.ДоговорыВзаиморасчетов
    - КаталогЗагрузки: Строка(500) - путь к каталогу с файлами XML


3. ТРЕБОВАНИЯ К ОБРАБОТКЕ ОШИБОК

3.1. Типы ошибок

3.1.1. Критические (прерывают обработку файла):
    - Файл не найден
    - Ошибка формата XML
    - Отсутствие обязательных настроек

3.2. Обработка ошибок

3.2.1. Все ошибки должны записываться в:
    - Журнал регистрации 1С

3.2.2. При критической ошибке:
    - Откатить все изменения по файлу


4. ТРЕБОВАНИЯ К ПРОИЗВОДИТЕЛЬНОСТИ

4.1. Ограничения
    - Использование транзакций для группы связанных документов
    - [Пакетная обработка записей (по 50-100 операций)]


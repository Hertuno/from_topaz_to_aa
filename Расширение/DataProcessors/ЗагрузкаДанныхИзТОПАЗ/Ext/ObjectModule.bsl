#Область СлужебныйПрограммныйИнтерфейс

// Выполняет загрузку данных из XML файлов ТОПАЗ
//
// Параметры:
//  ДеньЗагрузки - Дата - день загрузки данных из XML файлов ТОПАЗ
//
Процедура ВыполнитьЗагрузку(Знач ДеньЗагрузки = Неопределено) Экспорт
	
	РучнойЗапуск = ДеньЗагрузки <> Неопределено;
	ИмяСобытия = "ЗагрузкаТОПАЗ";

	Попытка
		
		Настройки = ЗагрузкаТОПАЗОбщий.ПолучитьНастройки();
		
		Если Настройки.Количество() = 0 Тогда
			ВызватьИсключение "Настройки загрузки не заполнены. Заполните регистр сведений НастройкиЗагрузкиТОПАЗ.";
		КонецЕсли;
		
		КаталогЗагрузки = Настройки.КаталогЗагрузки;
		
		Если ПустаяСтрока(КаталогЗагрузки) Тогда
			ВызватьИсключение "Не указан каталог загрузки в настройках.";
		КонецЕсли;
		
		// Поиск XML файлов за текущие сутки
		Если ДеньЗагрузки = Неопределено Тогда
			ТекущаяДата = ТекущаяДатаСеанса();
		Иначе
			ТекущаяДата = ДеньЗагрузки;
		КонецЕсли;
		
		МаскаФайла = СтрШаблон("CloseSession_%1*.xml", Формат(ТекущаяДата, "ДФ=yyyy-MM-dd"));
		НайденныеФайлы = НайтиФайлы(КаталогЗагрузки, МаскаФайла);
		Если НайденныеФайлы.Количество() = 0 Тогда
			ВызватьИсключение "Не найдены XML файлы за день: " + Формат(ТекущаяДата, "ДФ=4");
		КонецЕсли;
		
		// Определение даты документа
		ДатаДокумента = КонецДня(ТекущаяДата);
		
		// Сбор всех операций за день из всех файлов
		ВсеОперацииРозницы = Новый Массив;
		ВсеОперацииТоваров = Новый Массив;
		ВсеОперацииТопливныхКарт = Новый Массив;
		
		ОбработанныеФайлы = 0;
		Ошибки = Новый Массив;
		
		Для Каждого ПутьКФайлу Из НайденныеФайлы Цикл
			
			Попытка
				
				// Извлечение операций из файла
				ОперацииРозницы = ИзвлечьОперацииРозницы(ПутьКФайлу);
				ОперацииТоваров = ИзвлечьОперацииТоваровРозницы(ПутьКФайлу);
				ОперацииТопливныхКарт = ИзвлечьОперацииТопливныхКарт(ПутьКФайлу);
				
				// Добавление в общие массивы за день
				Для Каждого Операция Из ОперацииРозницы Цикл
					ВсеОперацииРозницы.Добавить(Операция);
				КонецЦикла;
				
				Для Каждого Операция Из ОперацииТоваров Цикл
					ВсеОперацииТоваров.Добавить(Операция);
				КонецЦикла;
				
				Для Каждого Операция Из ОперацииТопливныхКарт Цикл
					ВсеОперацииТопливныхКарт.Добавить(Операция);
				КонецЦикла;
				
				ОбработанныеФайлы = ОбработанныеФайлы + 1;
				Комментарий = "Файл успешно прочитан: " + ПутьКФайлу;
				РегистрацияПрогресса(ИмяСобытия, "Информация", Комментарий);
				
			Исключение
				ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				Комментарий = СтрШаблон("Ошибка при чтении файла %1: %2", ПутьКФайлу, ТекстОшибки);
				Ошибки.Добавить(Комментарий);
				
				РегистрацияПрогресса(ИмяСобытия, "Ошибка", Комментарий, РучнойЗапуск);
			КонецПопытки;
			
		КонецЦикла;
		
		// Создание агрегированных документов за день
		Попытка
			
			// Розничные операции по топливу (OutcomeByRetail)
			Если ВсеОперацииРозницы.Количество() > 0 Тогда
				СоздатьДокументыРозницыЗаДень(ВсеОперацииРозницы, ДатаДокумента, Настройки);
				Комментарий = СтрШаблон("Создан комплект документов розницы за день. Операций обработано: %1", ВсеОперацииРозницы.Количество());
				РегистрацияПрогресса(ИмяСобытия, "Информация", Комментарий);
			КонецЕсли;
			
			// Продажа товаров (ItemOutcomesByRetail)
			Если ВсеОперацииТоваров.Количество() > 0 Тогда
				СоздатьДокументыРеализацииТоваровЗаДень(ВсеОперацииТоваров, ДатаДокумента, Настройки);
				Комментарий = СтрШаблон("Создан документ реализации товаров за день. Позиций обработано: %1", ВсеОперацииТоваров.Количество());
				РегистрацияПрогресса(ИмяСобытия, "Информация", Комментарий);
			КонецЕсли;
			
			// Операции по топливным картам (OutcomeByOffice) - обрабатываем по одной
			Для Каждого Операция Из ВсеОперацииТопливныхКарт Цикл
				Попытка
					СоздатьДокументыТопливныхКарт(Операция, ДатаДокумента, Настройки, Неопределено);
				Исключение
					ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
					Комментарий = "Ошибка при создании документов по топливным картам: " + ТекстОшибки;
					РегистрацияПрогресса(ИмяСобытия, "Ошибка", Комментарий, РучнойЗапуск);
				КонецПопытки;
			КонецЦикла;
			
		Исключение
			ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			Комментарий = "Ошибка при создании документов за день: " + ТекстОшибки;
			РегистрацияПрогресса(ИмяСобытия, "Ошибка", Комментарий, РучнойЗапуск);
			ВызватьИсключение;
		КонецПопытки;
		
		// Проверка последнего дня месяца
		Если День(КонецМесяца(ТекущаяДата)) = День(ТекущаяДата) Тогда
			
			Попытка
				ОбработатьПоследнийДеньМесяца(Настройки);
			Исключение
				ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				Комментарий = "Ошибка при обработке последнего дня месяца: " + ТекстОшибки;
				Ошибки.Добавить(Комментарий);
				
				РегистрацияПрогресса(ИмяСобытия, "Ошибка", Комментарий, РучнойЗапуск);
			КонецПопытки;
			
		КонецЕсли;
		
		Комментарий = "Загрузка завершена. Обработано файлов: " + ОбработанныеФайлы;

		РегистрацияПрогресса(ИмяСобытия, "Информация", Комментарий);
		
	Исключение
		
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		Комментарий = "Критическая ошибка при выполнении загрузки: " + ТекстОшибки;
		РегистрацияПрогресса(ИмяСобытия, "Ошибка", Комментарий, РучнойЗапуск);
		
		ВызватьИсключение ТекстОшибки;
		
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Читает и парсит XML файл с кодировкой windows-1251
//
// Параметры:
//  ПутьКФайлу - Строка - полный путь к XML файлу
//
// Возвращаемое значение:
//  XMLReader - объект чтения XML, или Неопределено при ошибке
//
Функция ПрочитатьИзФайла(ПутьКФайлу)
	
	Попытка
		
		// Чтение и парсинг XML с кодировкой windows-1251
		// Проверка существования файла происходит автоматически при попытке открыть его
		// Сначала читаем файл как текст с кодировкой Windows-1251
		ЧтениеТекста = Новый ЧтениеТекста;
		ЧтениеТекста.Открыть(ПутьКФайлу.ПолноеИмя, , "windows-1251");
		
		ТекстXML = ЧтениеТекста.Прочитать();
		ЧтениеТекста.Закрыть();
		
		// Затем создаем объект чтения XML из строки
		ЧтениеXML = Новый ЧтениеXML;
		ЧтениеXML.УстановитьСтроку(ТекстXML);
		
		Возврат ЧтениеXML;
		
	Исключение
		
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
			УровеньЖурналаРегистрации.Ошибка, , , 
			"Ошибка при чтении XML файла " + ПутьКФайлу + ": " + ТекстОшибки);
		
		Возврат Неопределено;
		
	КонецПопытки;
	
КонецФункции

// Извлекает данные сессии из XML
//
// Параметры:
//  ПутьКФайлу - Строка - полный путь к XML файлу
//
// Возвращаемое значение:
//  Структура - структура с данными сессии
//
Функция ИзвлечьДанныеСессии(ПутьКФайлу)
	
	ДанныеСессии = Новый Структура;
	ЧтениеXML = Неопределено;
	
	Попытка
		
		ЧтениеXML = ПрочитатьИзФайла(ПутьКФайлу);
		
		Если ЧтениеXML = Неопределено Тогда
			ВызватьИсключение "Не удалось открыть XML файл: " + ПутьКФайлу;
		КонецЕсли;
		
		// Поиск корневого элемента DataPaket
		Пока ЧтениеXML.Прочитать() Цикл
			
			Если НЕ (ЧтениеXML.Имя = "DataPaket" И ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента) Тогда
				Прервать;
			КонецЕсли;
				
			// Извлечение атрибутов DataPaket
			ДанныеСессии.Вставить("Version", ЧтениеXML.ЗначениеАтрибута("Version"));
			ДанныеСессии.Вставить("DateTime", ЧтениеXML.ЗначениеАтрибута("DateTime"));
			ДанныеСессии.Вставить("Type", ЧтениеXML.ЗначениеАтрибута("Type"));
			ДанныеСессии.Вставить("AZSCode", ЧтениеXML.ЗначениеАтрибута("AZSCode"));
			
			// Парсинг даты и времени
			СтрокаДатыВремени = Строка(ДанныеСессии.DateTime);
			Попытка
				ДанныеСессии.Вставить("ДатаФайла", Дата(СтрокаДатыВремени));
			Исключение
				ДанныеСессии.Вставить("ДатаФайла", ТекущаяДатаСеанса());
			КонецПопытки;
			
			// Поиск элемента Session
			Пока ЧтениеXML.Прочитать() Цикл
				
				Если ЧтениеXML.Имя = "Session" И ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
					
					ДанныеСессии.Вставить("SessionNum", ЧтениеXML.ЗначениеАтрибута("SessionNum"));
					ДанныеСессии.Вставить("StartDateTime", ЧтениеXML.ЗначениеАтрибута("StartDateTime"));
					ДанныеСессии.Вставить("EndDateTime", ЧтениеXML.ЗначениеАтрибута("EndDateTime"));
					ДанныеСессии.Вставить("UserName", ЧтениеXML.ЗначениеАтрибута("UserName"));
					
					Прервать;
					
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЦикла;
		
		// Закрытие чтения XML
		ЧтениеXML.Закрыть();
		
	Исключение
		
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
			УровеньЖурналаРегистрации.Ошибка, , , 
			"Ошибка при извлечении данных сессии: " + ТекстОшибки);
		
		Если ЧтениеXML <> Неопределено Тогда
			Попытка
				ЧтениеXML.Закрыть();
			Исключение
				// Ошибка при закрытии чтения игнорируется
			КонецПопытки;
		КонецЕсли;
		
		ВызватьИсключение;
		
	КонецПопытки;
	
	Возврат ДанныеСессии;
	
КонецФункции

// Извлекает операции розницы (OutcomeByRetail) из XML
//
// Параметры:
//  ПутьКФайлу - Строка - полный путь к XML файлу
//
// Возвращаемое значение:
//  Массив - массив структур с данными операций
//
Функция ИзвлечьОперацииРозницы(ПутьКФайлу)
	
	Операции = Новый Массив;
	ЧтениеXML = Неопределено;
	
	Попытка
		
		ЧтениеXML = ПрочитатьИзФайла(ПутьКФайлу);
		
		Если ЧтениеXML = Неопределено Тогда
			Возврат Операции;
		КонецЕсли;
		
		// Поиск блока OutcomeByRetail и извлечение операций
		Пока ЧтениеXML.Прочитать() Цикл
			
			Если НЕ (ЧтениеXML.Имя = "OutcomeByRetail" И ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента) Тогда
				Продолжить;
			КонецЕсли;
			
			Если ЧтениеXML.ЗначениеАтрибута("PaymentModeName") = "Топливная карта" Тогда
				Продолжить;
			КонецЕсли;
				
			Операция = Новый Структура;
			Операция.Вставить("TankNum", ЧтениеXML.ЗначениеАтрибута("TankNum"));
			Операция.Вставить("HoseName", ЧтениеXML.ЗначениеАтрибута("HoseName"));
			Операция.Вставить("FuelName", ЧтениеXML.ЗначениеАтрибута("FuelName"));
			Операция.Вставить("PaymentModeName", ЧтениеXML.ЗначениеАтрибута("PaymentModeName"));
			
			Операция.Вставить("Volume", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ЧтениеXML.ЗначениеАтрибута("Volume")));
			Операция.Вставить("Amount", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ЧтениеXML.ЗначениеАтрибута("Amount")));
			Операция.Вставить("OrigPrice", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ЧтениеXML.ЗначениеАтрибута("OrigPrice")));
			Операция.Вставить("AmountCash", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ЧтениеXML.ЗначениеАтрибута("AmountCash")));
			Операция.Вставить("AmountCashless", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ЧтениеXML.ЗначениеАтрибута("AmountCashless")));
			Операция.Вставить("OrderCount", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ЧтениеXML.ЗначениеАтрибута("OrderCount")));
			
			Операции.Добавить(Операция);
			
		КонецЦикла;
		
		ЧтениеXML.Закрыть();
		
	Исключение
		
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
			УровеньЖурналаРегистрации.Ошибка, , , 
			"Ошибка при извлечении операций розницы: " + ТекстОшибки);
		
		Если ЧтениеXML <> Неопределено Тогда
			Попытка
				ЧтениеXML.Закрыть();
			Исключение
				// Ошибка при закрытии чтения игнорируется
			КонецПопытки;
		КонецЕсли;
		
	КонецПопытки;
	
	Возврат Операции;
	
КонецФункции

// Извлекает операции продажи товаров (ItemOutcomesByRetail) из XML
//
// Параметры:
//  ПутьКФайлу - Строка - полный путь к XML файлу
//
// Возвращаемое значение:
//  Массив - массив структур с данными операций по товарам
//
Функция ИзвлечьОперацииТоваровРозницы(ПутьКФайлу)
	
	Операции = Новый Массив;
	ЧтениеXML = Неопределено;
	
	Попытка
		
		ЧтениеXML = ПрочитатьИзФайла(ПутьКФайлу);
		
		Если ЧтениеXML = Неопределено Тогда
			Возврат Операции;
		КонецЕсли;
		
		// Поиск блока ItemOutcomesByRetail и извлечение операций
		Пока ЧтениеXML.Прочитать() Цикл
			
			Если НЕ (ЧтениеXML.Имя = "ItemOutcomeByRetail" И ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента) Тогда
				Продолжить;
			КонецЕсли;
			
			Операция = Новый Структура;
			Операция.Вставить("ItemName", ЧтениеXML.ЗначениеАтрибута("ItemName"));
			Операция.Вставить("ItemFullName", ЧтениеXML.ЗначениеАтрибута("ItemFullName"));
			Операция.Вставить("ItemCode", ЧтениеXML.ЗначениеАтрибута("ItemCode"));
			Операция.Вставить("PaymentModeName", ЧтениеXML.ЗначениеАтрибута("PaymentModeName"));
			Операция.Вставить("PartnerName", ЧтениеXML.ЗначениеАтрибута("PartnerName"));
			Операция.Вставить("Nds", ЧтениеXML.ЗначениеАтрибута("Nds"));
			Операция.Вставить("Unit", ЧтениеXML.ЗначениеАтрибута("Unit"));
			Операция.Вставить("IsReturn", ЧтениеXML.ЗначениеАтрибута("IsReturn"));
			
			Операция.Вставить("Quantity", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ЧтениеXML.ЗначениеАтрибута("Quantity")));
			Операция.Вставить("Amount", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ЧтениеXML.ЗначениеАтрибута("Amount")));
			Операция.Вставить("PriceRetail", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ЧтениеXML.ЗначениеАтрибута("PriceRetail")));
			Операция.Вставить("PriceIn", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ЧтениеXML.ЗначениеАтрибута("PriceIn")));
			
			// Фильтр: пропускаем возвраты
			Если Операция.IsReturn = "1" Тогда
				Продолжить;
			КонецЕсли;
			
			Операции.Добавить(Операция);
			
		КонецЦикла;
		
		ЧтениеXML.Закрыть();
		
	Исключение
		
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
			УровеньЖурналаРегистрации.Ошибка, , , 
			"Ошибка при извлечении операций товаров розницы: " + ТекстОшибки);
		
		Если ЧтениеXML <> Неопределено Тогда
			Попытка
				ЧтениеXML.Закрыть();
			Исключение
				// Ошибка при закрытии чтения игнорируется
			КонецПопытки;
		КонецЕсли;
		
	КонецПопытки;
	
	Возврат Операции;
	
КонецФункции

// Извлекает операции по топливным картам (OutcomeByOffice) из XML
//
// Параметры:
//  ПутьКФайлу - Строка - полный путь к XML файлу
//
// Возвращаемое значение:
//  Массив - массив структур с данными операций
//
Функция ИзвлечьОперацииТопливныхКарт(ПутьКФайлу)
	
	Операции = Новый Массив;
	ЧтениеXML = Неопределено;
	
	Попытка
		
		ЧтениеXML = ПрочитатьИзФайла(ПутьКФайлу);
		
		Если ЧтениеXML = Неопределено Тогда
			Возврат Операции;
		КонецЕсли;
		
		// Поиск блока OutcomeByOffice и извлечение операций
		Пока ЧтениеXML.Прочитать() Цикл
			
			Если НЕ (ЧтениеXML.Имя = "OutcomeByOffice" И ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента) Тогда
				Продолжить;
			КонецЕсли;
			
			Если ЧтениеXML.ЗначениеАтрибута("PaymentModeName") <> "Топливная карта" Тогда
				Продолжить;
			КонецЕсли;
				
			Операция = Новый Структура;
			Операция.Вставить("Date", ЧтениеXML.ЗначениеАтрибута("Date"));
			Операция.Вставить("Time", ЧтениеXML.ЗначениеАтрибута("Time"));
			Операция.Вставить("TankNum", ЧтениеXML.ЗначениеАтрибута("TankNum"));
			Операция.Вставить("HoseName", ЧтениеXML.ЗначениеАтрибута("HoseName"));
			Операция.Вставить("FuelName", ЧтениеXML.ЗначениеАтрибута("FuelName"));
			Операция.Вставить("PaymentModeName", ЧтениеXML.ЗначениеАтрибута("PaymentModeName"));
			
			Операция.Вставить("Volume", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ЧтениеXML.ЗначениеАтрибута("Volume")));
			Операция.Вставить("Amount", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ЧтениеXML.ЗначениеАтрибута("Amount")));
			Операция.Вставить("OrigPrice", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ЧтениеXML.ЗначениеАтрибута("OrigPrice")));
			Операция.Вставить("AmountTotal", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ЧтениеXML.ЗначениеАтрибута("AmountTotal")));
			
			// Дочерние элементы (читаем текст узлов)
			Операция.Вставить("CardCode", "");
			Операция.Вставить("PartnerName", "");
			Операция.Вставить("PartnerINN", "");
			Операция.Вставить("LimitCard_CarName", "");
			Операция.Вставить("LimitCard_CarNumber", "");
			
			// Чтение дочерних элементов
			Пока ЧтениеXML.Прочитать() Цикл
				
				Если ЧтениеXML.Имя = "OutcomesByOffice" И ЧтениеXML.ТипУзла = ТипУзлаXML.КонецЭлемента Тогда
					Прервать;
				КонецЕсли;
				
				Если НЕ ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
					Продолжить;
				КонецЕсли;
				
				Если ЧтениеXML.Имя = "CardCode" Тогда 
					ЧтениеXML.Прочитать();
					Операция.CardCode = СокрЛП(ЧтениеXML.Значение);
				ИначеЕсли ЧтениеXML.Имя = "PartnerName" Тогда 
					ЧтениеXML.Прочитать();
					Операция.PartnerName = СокрЛП(ЧтениеXML.Значение);
				ИначеЕсли ЧтениеXML.Имя = "PartnerINN" Тогда 
					ЧтениеXML.Прочитать();
					Операция.PartnerINN = СокрЛП(ЧтениеXML.Значение);
				ИначеЕсли ЧтениеXML.Имя = "LimitCard_CarName" Тогда 
					ЧтениеXML.Прочитать();
					Операция.LimitCard_CarName = СокрЛП(ЧтениеXML.Значение);
				ИначеЕсли ЧтениеXML.Имя = "LimitCard_CarNumber" Тогда 
					ЧтениеXML.Прочитать();
					Операция.LimitCard_CarNumber = СокрЛП(ЧтениеXML.Значение);
				КонецЕсли;
				
			КонецЦикла;
			
			// Фильтр: только топливные карты с ИНН
			Если ПустаяСтрока(Строка(Операция.PartnerINN)) Тогда
				Продолжить;			
			КонецЕсли;
			
			Операции.Добавить(Операция);
			
		КонецЦикла;
		
		ЧтениеXML.Закрыть();
		
	Исключение
		
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
			УровеньЖурналаРегистрации.Ошибка, , , 
			"Ошибка при извлечении операций по топливным картам: " + ТекстОшибки);
		
		Если ЧтениеXML <> Неопределено Тогда
			Попытка
				ЧтениеXML.Закрыть();
			Исключение
				// Ошибка при закрытии чтения игнорируется
			КонецПопытки;
		КонецЕсли;
		
	КонецПопытки;
	
	Возврат Операции;
	
КонецФункции

// Создает агрегированные документы для розничных операций по топливу за день
//
// Параметры:
//  МассивОпераций - Массив - массив структур с данными операций за день
//  ДатаДокумента - Дата - дата создания документов
//  Настройки - Структура - настройки загрузки
//
Процедура СоздатьДокументыРозницыЗаДень(МассивОпераций, ДатаДокумента, Настройки)
	
	НачатьТранзакцию();
	
	Попытка
		
		// Поиск контрагента "Частное Лицо"
		Контрагент = ЗагрузкаТОПАЗОбщий.НайтиКонтрагентаЧастноеЛицо();
		
		Если Контрагент = Неопределено Тогда
			ВызватьИсключение "Не найден контрагент 'Частное Лицо'";
		КонецЕсли;
		
		// Агрегация операций по FuelName
		Группы = Новый Соответствие;
		ИтогоAmountCash = 0;
		ИтогоAmountCashless = 0;
		
		Для Каждого Операция Из МассивОпераций Цикл
			
			КлючГруппы = Операция.FuelName;
			
			Если Группы[КлючГруппы] = Неопределено Тогда
				Группа = Новый Структура;
				Группа.Вставить("FuelName", Операция.FuelName);
				Группа.Вставить("Volume", 0);
				Группа.Вставить("Amount", 0);
				Группа.Вставить("СуммаДляЦены", 0); // для средневзвешенной цены
				Группы.Вставить(КлючГруппы, Группа);
			КонецЕсли;
			
			Группа = Группы[КлючГруппы];
			Группа.Volume = Группа.Volume + Операция.Volume;
			Группа.Amount = Группа.Amount + Операция.Amount;
			Группа.СуммаДляЦены = Группа.СуммаДляЦены + (Операция.Volume * Операция.OrigPrice);
			
			// Суммы оплат по всем операциям
			ИтогоAmountCash = ИтогоAmountCash + Операция.AmountCash;
			ИтогоAmountCashless = ИтогоAmountCashless + Операция.AmountCashless;
			
		КонецЦикла;
		
		// 1. Создание документа "Реализация товаров"
		ДокументРеализация = Документы.РеализацияТоваров.СоздатьДокумент();
		ДокументРеализация.Дата = ДатаДокумента;
		ДокументРеализация.Контрагент = Контрагент;
		ДокументРеализация.ДоговорВзаиморасчетов = Настройки.ДоговорРозничныйПоУмолчанию;
		ДокументРеализация.Организация = Настройки.Организация;
		ДокументРеализация.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
		ДокументРеализация.СкладКомпании = Настройки.СкладКомпании;
		ДокументРеализация.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643"); // RUB
		ДокументРеализация.КурсДокумента = 1;
		ДокументРеализация.ХозОперация = Справочники.ХозОперации.РеализацияТоваров;
		ДокументРеализация.РегламентированныйУчет = Истина;
		ДокументРеализация.ЭтоУниверсальныйДокумент = Истина;
		ДокументРеализация.СпособЗачетаАвансов = Перечисления.СпособыЗачетаАвансов.НеЗачитывать;
		ДокументРеализация.ТипЦен = Настройки.ТипЦен;
		ДокументРеализация.Менеджер = Настройки.МенеджерПоУмолчанию;
		ДокументРеализация.Комментарий = "Розничная реализация топлива за день";
		
		// Заполнение табличной части "Товары" - по одной строке на FuelName
		Для Каждого ЭлементГруппы Из Группы Цикл
			
			Группа = ЭлементГруппы.Значение;
			
			// Поиск номенклатуры
			Номенклатура = ЗагрузкаТОПАЗОбщий.НайтиНоменклатуруПоНаименованию(Группа.FuelName);
			
			Если Номенклатура = Неопределено Тогда
				ВызватьИсключение "Не найдена номенклатура: " + Группа.FuelName;
			КонецЕсли;
			
			// Расчёт средневзвешенной цены
			СредневзвешеннаяЦена = 0;
			Если Группа.Volume > 0 Тогда
				СредневзвешеннаяЦена = Группа.СуммаДляЦены / Группа.Volume;
			КонецЕсли;
			
			НоваяСтрока = ДокументРеализация.Товары.Добавить();
			НоваяСтрока.Номенклатура = Номенклатура;
			НоваяСтрока.ЕдиницаИзмерения = Номенклатура.ОсновнаяЕдиницаИзмерения;
			НоваяСтрока.Коэффициент	= Номенклатура.ОсновнаяЕдиницаИзмерения.Коэффициент;
			НоваяСтрока.Количество = Группа.Volume;
			НоваяСтрока.Цена = СредневзвешеннаяЦена;
			НоваяСтрока.Сумма = Группа.Amount;
			НоваяСтрока.СуммаВсего = Группа.Amount;
			НоваяСтрока.СтавкаНДС = Справочники.СтавкиНДС.ОсновнаяСтавкаНДС;
			НоваяСтрока.СуммаНДС = ЗагрузкаТОПАЗОбщий.РассчитатьСуммуНДС(Группа.Amount, Справочники.СтавкиНДС.ОсновнаяСтавкаНДС.Ставка);
			
		КонецЦикла;
		
		ДокументРеализация.Записать(РежимЗаписиДокумента.Проведение);
		
		// 2. Создание документа "Чек на оплату"
		ДокументЧек = Документы.ЧекНаОплату.СоздатьДокумент();
		ДокументЧек.Дата = ДатаДокумента;
		ДокументЧек.ДокументОснование = ДокументРеализация.Ссылка;
		ДокументЧек.Контрагент = Контрагент;
		ДокументЧек.ДоговорВзаиморасчетов = Настройки.ДоговорРозничныйПоУмолчанию;
		ДокументЧек.Организация = Настройки.Организация;
		ДокументЧек.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
		ДокументЧек.КассаККМ = Настройки.КассаККМ;
		ДокументЧек.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
		ДокументЧек.ХозОперация = Справочники.ХозОперации.ЧекНаОплату;
		ДокументЧек.РегламентированныйУчет = Истина;
		ДокументЧек.СтавкаНДС = Справочники.СтавкиНДС.ОсновнаяСтавкаНДС;
		ДокументЧек.БлокироватьПерерасчетСкидок = Истина;
		ДокументЧек.ПризнакСпособаРасчета = Перечисления.ПризнакиСпособаРасчета.ПередачаСПолнойОплатой;
		ДокументЧек.Сделка = ДокументРеализация.Ссылка;
		ДокументЧек.СуммаДокумента = ДокументРеализация.СуммаДокумента;
		
		// Копирование табличной части "Товары"
		Для Каждого СтрокаТовара Из ДокументРеализация.Товары Цикл
			НоваяСтрокаЧека = ДокументЧек.Товары.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрокаЧека, СтрокаТовара);
			НоваяСтрокаЧека.СуммаОплаты = СтрокаТовара.СуммаВсего;
		КонецЦикла;
		
		// Заполнение табличной части "Оплаты" - итоговые суммы за день
		ДанныеОплаты = ЗагрузкаТОПАЗОбщий.ОпределитьСпособОплаты(ИтогоAmountCash, ИтогоAmountCashless);
		
		Если ДанныеОплаты.СпособОплаты <> Неопределено Тогда
			НоваяОплата = ДокументЧек.Оплаты.Добавить();
			НоваяОплата.ТипОплаты = ДанныеОплаты.СпособОплаты;
			НоваяОплата.Сумма = ДанныеОплаты.Сумма;
		КонецЕсли;
		
		Если ДанныеОплаты.Свойство("СпособОплаты2") И ДанныеОплаты.СпособОплаты2 <> Неопределено Тогда
			НоваяОплата2 = ДокументЧек.Оплаты.Добавить();
			НоваяОплата2.ТипОплаты = ДанныеОплаты.СпособОплаты2;
			НоваяОплата2.Сумма = ДанныеОплаты.Сумма2;
		КонецЕсли;
		
		ДокументЧек.Записать(РежимЗаписиДокумента.Проведение);
		
		// 3. Создание документа "Инкассация"
		ДокументИнкассация = Документы.Инкассация.СоздатьДокумент();
		ДокументИнкассация.Дата = ДатаДокумента;
		ДокументИнкассация.ДокументОснование = ДокументЧек.Ссылка;
		ДокументИнкассация.Организация = Настройки.Организация;
		ДокументИнкассация.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
		ДокументИнкассация.КассаККМ = Настройки.КассаККМ;
		ДокументИнкассация.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
		ДокументИнкассация.ХозОперация = Справочники.ХозОперации.ИзъятиеИзКассыККМ;
		ДокументИнкассация.Инкассатор = Настройки.Инкассатор;
		ДокументИнкассация.ДоговорВзаиморасчетовИнкассатор = Настройки.ДоговорИнкассации;
		ДокументИнкассация.ПлатежнаяСистема = Настройки.ПлатежнаяСистема;
		ДокументИнкассация.ДоговорВзаиморасчетовПлатежнаяСистема = Настройки.ДоговорПлатежнойСистемы;
		ДокументИнкассация.СуммаДокумента = ДокументЧек.СуммаДокумента;
		
		// Копирование табличной части "Оплаты"
		Для Каждого СтрокаОплаты Из ДокументЧек.Оплаты Цикл
			НоваяОплатаИнкассации = ДокументИнкассация.Оплаты.Добавить();
			НоваяОплатаИнкассации.ТипОплаты = СтрокаОплаты.ТипОплаты;
			НоваяОплатаИнкассации.Сумма = СтрокаОплаты.Сумма;
		КонецЦикла;
		
		ДокументИнкассация.Записать(РежимЗаписиДокумента.Проведение);
		
		// 4. Создание документа "Приходный кассовый ордер" (только для наличных)
		Если ИтогоAmountCash > 0 Тогда
			
			ДокументПКО = Документы.ПриходныйКассовыйОрдер.СоздатьДокумент();
			ДокументПКО.Дата = ДатаДокумента;
			ДокументПКО.ДокументОснование = ДокументИнкассация.Ссылка;
			ДокументПКО.Организация = Настройки.Организация;
			ДокументПКО.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
			ДокументПКО.КассаКомпании = Настройки.КассаКомпании;
			ДокументПКО.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
			ДокументПКО.ХозОперация = Справочники.ХозОперации.ПриходныйКассовыйОрдер;
			ДокументПКО.РегламентированныйУчет = Истина;
			ДокументПКО.Контрагент = Настройки.Инкассатор;
			ДокументПКО.ДоговорВзаиморасчетов = Настройки.ДоговорИнкассации;
			ДокументПКО.ВидОперации = Перечисления.ВидыОперацийДвиженияДенежныхСредств.Инкассация;
			ДокументПКО.СуммаДокумента = ИтогоAmountCash;
			
			ДокументПКО.Записать(РежимЗаписиДокумента.Проведение);
			
		КонецЕсли;
		
		// Счёт-фактура выданный НЕ создаётся ежедневно, только по итоговой реализации за месяц
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		ВызватьИсключение;
		
	КонецПопытки;
	
КонецПроцедуры

// Создает документы реализации товаров за день (ItemOutcomesByRetail)
//
// Параметры:
//  МассивОпераций - Массив - массив структур с данными операций по товарам за день
//  ДатаДокумента - Дата - дата создания документов
//  Настройки - Структура - настройки загрузки
//
Процедура СоздатьДокументыРеализацииТоваровЗаДень(МассивОпераций, ДатаДокумента, Настройки)
	
	НачатьТранзакцию();
	
	Попытка
		
		// Поиск контрагента "Частное Лицо"
		Контрагент = ЗагрузкаТОПАЗОбщий.НайтиКонтрагентаЧастноеЛицо();
		
		Если Контрагент = Неопределено Тогда
			ВызватьИсключение "Не найден контрагент 'Частное Лицо'";
		КонецЕсли;
		
		// Агрегация товаров по ItemCode
		Группы = Новый Соответствие;
		ИтогоСуммаНаличные = 0;
		ИтогоСуммаБезналичные = 0;
		
		Для Каждого Операция Из МассивОпераций Цикл
			
			КлючГруппы = Операция.ItemCode;
			
			Если Группы[КлючГруппы] = Неопределено Тогда
				Группа = Новый Структура;
				Группа.Вставить("ItemName", Операция.ItemName);
				Группа.Вставить("ItemCode", Операция.ItemCode);
				Группа.Вставить("Quantity", 0);
				Группа.Вставить("Amount", 0);
				Группа.Вставить("Nds", Операция.Nds);
				Группа.Вставить("PriceRetail", Операция.PriceRetail);
				Группа.Вставить("PaymentModeName", Операция.PaymentModeName);
				Группы.Вставить(КлючГруппы, Группа);
			КонецЕсли;
			
			Группа = Группы[КлючГруппы];
			Группа.Quantity = Группа.Quantity + Операция.Quantity;
			Группа.Amount = Группа.Amount + Операция.Amount;
			
			// Подсчёт сумм для оплат (упрощённо: считаем все как наличные/безналичные по PaymentModeName)
			Если Операция.PaymentModeName = "Терминал" Тогда
				ИтогоСуммаБезналичные = ИтогоСуммаБезналичные + Операция.Amount;
			Иначе
				ИтогоСуммаНаличные = ИтогоСуммаНаличные + Операция.Amount;
			КонецЕсли;
			
		КонецЦикла;
		
		// Создание документа "Реализация товаров"
		ДокументРеализация = Документы.РеализацияТоваров.СоздатьДокумент();
		ДокументРеализация.Дата = ДатаДокумента;
		ДокументРеализация.Контрагент = Контрагент;
		ДокументРеализация.ДоговорВзаиморасчетов = Настройки.ДоговорРозничныйПоУмолчанию;
		ДокументРеализация.Организация = Настройки.Организация;
		ДокументРеализация.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
		ДокументРеализация.СкладКомпании = Настройки.СкладКомпании;
		ДокументРеализация.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
		ДокументРеализация.КурсДокумента = 1;
		ДокументРеализация.ХозОперация = Справочники.ХозОперации.РеализацияТоваров;
		ДокументРеализация.РегламентированныйУчет = Истина;
		ДокументРеализация.ЭтоУниверсальныйДокумент = Истина;
		ДокументРеализация.СпособЗачетаАвансов = Перечисления.СпособыЗачетаАвансов.НеЗачитывать;
		ДокументРеализация.ТипЦен = Настройки.ТипЦен;
		ДокументРеализация.Менеджер = Настройки.МенеджерПоУмолчанию;
		ДокументРеализация.Комментарий = "Розничная реализация товаров за день";
		
		// Заполнение табличной части "Товары"
		Для Каждого ЭлементГруппы Из Группы Цикл
			
			Группа = ЭлементГруппы.Значение;
			
			// Поиск номенклатуры по коду или наименованию
			Номенклатура = ЗагрузкаТОПАЗОбщий.НайтиНоменклатуруПоКоду(Группа.ItemCode);
			
			Если Номенклатура = Неопределено Тогда
				Номенклатура = ЗагрузкаТОПАЗОбщий.НайтиНоменклатуруПоНаименованию(Группа.ItemName);
			КонецЕсли;
			
			Если Номенклатура = Неопределено Тогда
				ВызватьИсключение "Не найдена номенклатура: " + Группа.ItemName + " (код: " + Группа.ItemCode + ")";
			КонецЕсли;
			
			// Расчёт цены
			Цена = 0;
			Если Группа.Quantity > 0 Тогда
				Цена = Группа.Amount / Группа.Quantity;
			КонецЕсли;
			
			// Парсинг ставки НДС из строки (например "22%" -> 22)
			СтавкаНДСПроцент = 20; // по умолчанию
			Если НЕ ПустаяСтрока(Группа.Nds) Тогда
				СтрокаСтавки = СтрЗаменить(Группа.Nds, "%", "");
				СтавкаНДСПроцент = СтроковыеФункцииКлиентСервер.СтрокаВЧисло(СтрокаСтавки);
			КонецЕсли;
			
			НоваяСтрока = ДокументРеализация.Товары.Добавить();
			НоваяСтрока.Номенклатура = Номенклатура;
			НоваяСтрока.ЕдиницаИзмерения = Номенклатура.ОсновнаяЕдиницаИзмерения;
			НоваяСтрока.Коэффициент = Номенклатура.ОсновнаяЕдиницаИзмерения.Коэффициент;
			НоваяСтрока.Количество = Группа.Quantity;
			НоваяСтрока.Цена = Цена;
			НоваяСтрока.Сумма = Группа.Amount;
			НоваяСтрока.СуммаВсего = Группа.Amount;
			НоваяСтрока.СтавкаНДС = Справочники.СтавкиНДС.ОсновнаяСтавкаНДС;
			НоваяСтрока.СуммаНДС = ЗагрузкаТОПАЗОбщий.РассчитатьСуммуНДС(Группа.Amount, СтавкаНДСПроцент);
			
		КонецЦикла;
		
		ДокументРеализация.Записать(РежимЗаписиДокумента.Проведение);
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		ВызватьИсключение;
		
	КонецПопытки;
	
КонецПроцедуры

// Создает документы для операций по топливным картам
//
// Параметры:
//  Операция - Структура - данные операции
//  ДатаДокумента - Дата - дата создания документов
//  Настройки - Структура - настройки загрузки
//  ДанныеСессии - Структура - данные сессии
//
Процедура СоздатьДокументыТопливныхКарт(Операция, ДатаДокумента, Настройки, ДанныеСессии)
	
	НачатьТранзакцию();
	
	Попытка
		
		// Поиск контрагента по ИНН
		Контрагент = ЗагрузкаТОПАЗОбщий.НайтиКонтрагентаПоИНН(Строка(Операция.PartnerINN));
		
		Если Контрагент = Неопределено Тогда
			ВызватьИсключение "Не найден контрагент с ИНН: " + Строка(Операция.PartnerINN);
		КонецЕсли;
		
		// Поиск договора контрагента
		Договор = ЗагрузкаТОПАЗОбщий.НайтиДоговорКонтрагента(Контрагент);
		
		Если Договор = Неопределено Тогда
			ВызватьИсключение "Не найден договор для контрагента: " + Контрагент;
		КонецЕсли;
		
		// Поиск номенклатуры
		Номенклатура = ЗагрузкаТОПАЗОбщий.НайтиНоменклатуруПоНаименованию(Операция.FuelName);
		
		Если Номенклатура = Неопределено Тогда
			ВызватьИсключение "Не найдена номенклатура: " + Операция.FuelName;
		КонецЕсли;
		
		// Формирование комментария
		Комментарий = "Топливная карта: " + Строка(Операция.CardCode);
		Если Не ПустаяСтрока(Строка(Операция.LimitCard_CarName)) Тогда
			Комментарий = Комментарий + ", Автомобиль: " + Строка(Операция.LimitCard_CarName);
		КонецЕсли;
		Если Не ПустаяСтрока(Строка(Операция.LimitCard_CarNumber)) Тогда
			Комментарий = Комментарий + " " + Строка(Операция.LimitCard_CarNumber);
		КонецЕсли;
		
		// 1. Создание документа "Реализация товаров"
		ДокументРеализация = Документы.РеализацияТоваров.СоздатьДокумент();
		ДокументРеализация.Дата = ДатаДокумента;
		ДокументРеализация.Контрагент = Контрагент;
		ДокументРеализация.ДоговорВзаиморасчетов = Договор;
		ДокументРеализация.Организация = Настройки.Организация;
		ДокументРеализация.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
		ДокументРеализация.СкладКомпании = Настройки.СкладКомпании;
		ДокументРеализация.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
		ДокументРеализация.ХозОперация = Справочники.ХозОперации.РеализацияТоваров;
		ДокументРеализация.РегламентированныйУчет = Истина;
		ДокументРеализация.СпособЗачетаАвансов = Перечисления.СпособыЗачетаАвансов.НеЗачитывать;
		ДокументРеализация.ТипЦен = Настройки.ТипЦен;
		ДокументРеализация.Менеджер = Настройки.МенеджерПоУмолчанию;
		ДокументРеализация.Комментарий = Комментарий;
		ДокументРеализация.СуммаДокумента = Операция.Amount;
		
		// Заполнение табличной части "Товары"
		НоваяСтрока = ДокументРеализация.Товары.Добавить();
		НоваяСтрока.Номенклатура = Номенклатура;
		НоваяСтрока.ЕдиницаИзмерения = Номенклатура.ОсновнаяЕдиницаИзмерения;
		НоваяСтрока.Коэффициент	= Номенклатура.ОсновнаяЕдиницаИзмерения.Коэффициент;
		НоваяСтрока.Количество = Операция.Volume;
		НоваяСтрока.Цена = Операция.OrigPrice;
		НоваяСтрока.Сумма = Операция.Amount;
		НоваяСтрока.СуммаВсего = Операция.Amount;
		НоваяСтрока.СтавкаНДС = Справочники.СтавкиНДС.ОсновнаяСтавкаНДС;
		НоваяСтрока.СуммаНДС = ЗагрузкаТОПАЗОбщий.РассчитатьСуммуНДС(Операция.Amount, Справочники.СтавкиНДС.ОсновнаяСтавкаНДС.Ставка);
		
		
		// Определение ставки НДС по номенклатуре
		СтавкаНДС = Справочники.СтавкиНДС.ОсновнаяСтавкаНДС.Ставка; // По умолчанию
		Если Номенклатура.СтавкаНДС <> Неопределено Тогда
			СтавкаНДС = Номенклатура.СтавкаНДС;
		КонецЕсли;
		
		НоваяСтрока.СтавкаНДС = СтавкаНДС;
		НоваяСтрока.СуммаНДС = ЗагрузкаТОПАЗОбщий.РассчитатьСуммуНДС(Операция.Amount, СтавкаНДС.Ставка);
		
		ДокументРеализация.Записать(РежимЗаписиДокумента.Проведение);
		
		// 2. Создание документа "Счет-фактура выданный"
		ДокументСчетФактура = Документы.СчетФактураВыданный.СоздатьДокумент();
		ДокументСчетФактура.Дата = ДатаДокумента;
		ДокументСчетФактура.ДокументОснование = ДокументРеализация.Ссылка;
		ДокументСчетФактура.Контрагент = Контрагент;
		ДокументСчетФактура.ДоговорВзаиморасчетов = Договор;
		ДокументСчетФактура.Организация = Настройки.Организация;
		ДокументСчетФактура.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
		ДокументСчетФактура.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
		ДокументСчетФактура.РегламентированныйУчет = Истина; 
		ДокументСчетФактура.СуммаДокумента = ДокументРеализация.СуммаДокумента;
		
		// Копирование табличной части "Товары"
		Для Каждого СтрокаТовара Из ДокументРеализация.Товары Цикл
			НоваяСтрокаСФ = ДокументСчетФактура.Товары.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрокаСФ, СтрокаТовара);
		КонецЦикла;
		
		ДокументСчетФактура.Записать(РежимЗаписиДокумента.Проведение);
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		ВызватьИсключение;
		
	КонецПопытки;
	
КонецПроцедуры

// Обрабатывает последний день месяца: создает итоговые документы и помечает на удаление промежуточные
//
// Параметры:
//  Настройки - Структура - настройки загрузки
//
Процедура ОбработатьПоследнийДеньМесяца(Настройки)
	
	ТекущаяДата = ТекущаяДатаСеанса();
	НачалоМесяца = НачалоДня(НачалоМесяца(ТекущаяДата));
	КонецМесяца = КонецДня(КонецМесяца(ТекущаяДата));
	
	// Поиск всех документов "Реализация товаров" по топливным картам за текущий месяц
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	РеализацияТоваров.Ссылка КАК Ссылка,
		|	РеализацияТоваров.Контрагент КАК Контрагент,
		|	РеализацияТоваров.Дата КАК Дата
		|ИЗ
		|	Документ.РеализацияТоваров КАК РеализацияТоваров
		|ГДЕ
		|	РеализацияТоваров.Дата МЕЖДУ &НачалоМесяца И &КонецМесяца
		|	И РеализацияТоваров.Контрагент <> &ЧастноеЛицо
		|	И РеализацияТоваров.ПометкаУдаления = ЛОЖЬ
		|	И РеализацияТоваров.Проведен = ИСТИНА";
	
	ЧастноеЛицо = ЗагрузкаТОПАЗОбщий.НайтиКонтрагентаЧастноеЛицо();
	
	Запрос.УстановитьПараметр("НачалоМесяца", НачалоМесяца);
	Запрос.УстановитьПараметр("КонецМесяца", КонецМесяца);
	Запрос.УстановитьПараметр("ЧастноеЛицо", ЧастноеЛицо);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	// Группировка по контрагенту и номенклатуре
	Группы = Новый Соответствие;
	
	Пока Выборка.Следующий() Цикл
		
		ДокументРеализации = Выборка.Ссылка.ПолучитьОбъект();
		Контрагент = Выборка.Контрагент;
		
		Для Каждого СтрокаТовара Из ДокументРеализации.Товары Цикл
			
			КлючГруппы = Строка(Контрагент) + "|" + Строка(СтрокаТовара.Номенклатура);
			
			Если Не Группы.Получить(КлючГруппы) Тогда
				Группа = Новый Структура;
				Группа.Вставить("Контрагент", Контрагент);
				Группа.Вставить("Номенклатура", СтрокаТовара.Номенклатура);
				Группа.Вставить("Количество", 0);
				Группа.Вставить("Сумма", 0);
				Группа.Вставить("СуммаСЦеной", 0); // для расчета средневзвешенной цены
				Группа.Вставить("Документы", Новый Массив);
				Группы.Вставить(КлючГруппы, Группа);
			КонецЕсли;
			
			Группа = Группы.Получить(КлючГруппы);
			Группа.Количество = Группа.Количество + СтрокаТовара.Количество;
			Группа.Сумма = Группа.Сумма + СтрокаТовара.Сумма;
			Группа.СуммаСЦеной = Группа.СуммаСЦеной + (СтрокаТовара.Количество * СтрокаТовара.Цена);
			
			Если Группа.Документы.Найти(Выборка.Ссылка) = Неопределено Тогда
				Группа.Документы.Добавить(Выборка.Ссылка);
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;
	
	// Создание итоговых документов для каждой группы
	Для Каждого ЭлементГруппы Из Группы Цикл
		
		Группа = ЭлементГруппы.Значение;
		
		НачатьТранзакцию();
		
		Попытка
			
			// Поиск договора контрагента
			Договор = ЗагрузкаТОПАЗОбщий.НайтиДоговорКонтрагента(Группа.Контрагент);
			
			Если Договор = Неопределено Тогда
				ВызватьИсключение "Не найден договор для контрагента: " + Группа.Контрагент;
			КонецЕсли;
			
			// Расчет средневзвешенной цены
			СредневзвешеннаяЦена = 0;
			Если Группа.Количество > 0 Тогда
				СредневзвешеннаяЦена = Группа.СуммаСЦеной / Группа.Количество;
			КонецЕсли;
			
			// Определение ставки НДС
			СтавкаНДС = Справочники.СтавкиНДС.ОсновнаяСтавкаНДС.Ставка; // По умолчанию
			Если Группа.Номенклатура.СтавкаНДС <> Неопределено Тогда
				СтавкаНДС = Группа.Номенклатура.СтавкаНДС;
			КонецЕсли;
			
			// Создание итогового документа "Реализация товаров"
			ДатаИтоговогоДокумента = КонецМесяца;
			
			ДокументРеализация = Документы.РеализацияТоваров.СоздатьДокумент();
			ДокументРеализация.Дата = ДатаИтоговогоДокумента;
			ДокументРеализация.Контрагент = Группа.Контрагент;
			ДокументРеализация.ДоговорВзаиморасчетов = Договор;
			ДокументРеализация.Организация = Настройки.Организация;
			ДокументРеализация.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
			ДокументРеализация.СкладКомпании = Настройки.СкладКомпании;
			ДокументРеализация.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
			ДокументРеализация.ХозОперация = Справочники.ХозОперации.РеализацияТоваров;
			ДокументРеализация.РегламентированныйУчет = Истина;
			ДокументРеализация.СпособЗачетаАвансов = Перечисления.СпособыЗачетаАвансов.НеЗачитывать;
			ДокументРеализация.ТипЦен = Настройки.ТипЦен;
			ДокументРеализация.Менеджер = Настройки.МенеджерПоУмолчанию;
			
			Месяц = Формат(ТекущаяДата, "ДФ=MMMM");
			Год = Год(ТекущаяДата);
			ДокументРеализация.Комментарий = "Итоговая реализация за " + Месяц + " " + Год;
			
			// Заполнение табличной части "Товары"
			НоваяСтрока = ДокументРеализация.Товары.Добавить();
			НоваяСтрока.Номенклатура = Группа.Номенклатура;
			НоваяСтрока.Количество = Группа.Количество;
			НоваяСтрока.Цена = СредневзвешеннаяЦена;
			НоваяСтрока.Сумма = Группа.Сумма;
			НоваяСтрока.СтавкаНДС = СтавкаНДС;
			НоваяСтрока.СуммаНДС = ЗагрузкаТОПАЗОбщий.РассчитатьСуммуНДС(Группа.Сумма, СтавкаНДС);
			
			ДокументРеализация.Записать(РежимЗаписиДокумента.Проведение);
			
			// Создание итогового "Счет-фактура выданный"
			ДокументСчетФактура = Документы.СчетФактураВыданный.СоздатьДокумент();
			ДокументСчетФактура.Дата = ДатаИтоговогоДокумента;
			ДокументСчетФактура.ДокументОснование = ДокументРеализация.Ссылка;
			ДокументСчетФактура.Контрагент = Группа.Контрагент;
			ДокументСчетФактура.ДоговорВзаиморасчетов = Договор;
			ДокументСчетФактура.Организация = Настройки.Организация;
			ДокументСчетФактура.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
			ДокументСчетФактура.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
			ДокументСчетФактура.РегламентированныйУчет = Истина;
			
			// Копирование табличной части "Товары"
			Для Каждого СтрокаТовара Из ДокументРеализация.Товары Цикл
				НоваяСтрокаСФ = ДокументСчетФактура.Товары.Добавить();
				НоваяСтрокаСФ.Номенклатура = СтрокаТовара.Номенклатура;
				НоваяСтрокаСФ.Количество = СтрокаТовара.Количество;
				НоваяСтрокаСФ.Цена = СтрокаТовара.Цена;
				НоваяСтрокаСФ.Сумма = СтрокаТовара.Сумма;
				НоваяСтрокаСФ.СтавкаНДС = СтрокаТовара.СтавкаНДС;
				НоваяСтрокаСФ.СуммаНДС = СтрокаТовара.СуммаНДС;
			КонецЦикла;
			
			ДокументСчетФактура.Записать(РежимЗаписиДокумента.Проведение);
			
			// Пометить на удаление все исходные документы за месяц
			Для Каждого СсылкаДокумента Из Группа.Документы Цикл
				
				ДокументДляУдаления = СсылкаДокумента.ПолучитьОбъект();
				ДокументДляУдаления.УстановитьПометкуУдаления(Истина);
				ДокументДляУдаления.Записать();
				
				// Поиск и пометка на удаление соответствующих счетов-фактур
				ЗапросСФ = Новый Запрос;
				ЗапросСФ.Текст = 
				"ВЫБРАТЬ ПЕРВЫЕ 1
				|	СчетФактураВыданный.Ссылка КАК Ссылка
				|ИЗ
				|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
				|ГДЕ
				|	СчетФактураВыданный.ДокументОснование = &ДокументОснование
				|	И СчетФактураВыданный.ПометкаУдаления = ЛОЖЬ";
				
				ЗапросСФ.УстановитьПараметр("ДокументОснование", СсылкаДокумента);
				РезультатСФ = ЗапросСФ.Выполнить();
				ВыборкаСФ = РезультатСФ.Выбрать();
				
				Пока ВыборкаСФ.Следующий() Цикл
					ДокументСФ = ВыборкаСФ.Ссылка.ПолучитьОбъект();
					ДокументСФ.УстановитьПометкуУдаления(Истина);
					ДокументСФ.Записать();
				КонецЦикла;
				
			КонецЦикла;
			
			ЗафиксироватьТранзакцию();
			
		Исключение
			
			ОтменитьТранзакцию();
			ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
				УровеньЖурналаРегистрации.Ошибка, , , 
				"Ошибка при создании итоговых документов для контрагента " + Группа.Контрагент + ": " + ТекстОшибки);
			
		КонецПопытки;
		
	КонецЦикла;
	
КонецПроцедуры

// Регистрация прогресса обработки
//
// Параметры:
//  Событие - Строка - имя события
//  Уровень - Строка - уровень журнала регистрации [Информация, Предупреждение, Ошибка]
//  Комментарий - Строка - комментарий к событию
//  ВыводСообщений - Булево - если Истина, то выводить сообщение, иначе записывать в журнал регистрации
//
Процедура РегистрацияПрогресса(Знач Событие, Знач Уровень, Знач Комментарий = "", Знач ВыводСообщений = Ложь)
	
	Если ВыводСообщений Тогда
		Сообщить(СтрШаблон("%1: %2", Уровень, Комментарий));
	Иначе
		ЗаписьЖурналаРегистрации(Событие, УровеньЖурналаРегистрации[Уровень], , , Комментарий);
	КонецЕсли;

КонецПроцедуры

#КонецОбласти

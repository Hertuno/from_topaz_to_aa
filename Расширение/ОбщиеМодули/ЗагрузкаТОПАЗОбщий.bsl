#Область ПрограммныйИнтерфейс

// Получает настройки загрузки из регистра сведений
//
// Возвращаемое значение:
//  Структура - структура с настройками загрузки, ключи соответствуют реквизитам регистра
//
Функция ПолучитьНастройки() Экспорт
	
	Настройки = Новый Структура;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	НастройкиЗагрузкиТОПАЗ.Организация КАК Организация,
	|	НастройкиЗагрузкиТОПАЗ.ПодразделениеКомпании КАК ПодразделениеКомпании,
	|	НастройкиЗагрузкиТОПАЗ.СкладКомпании КАК СкладКомпании,
	|	НастройкиЗагрузкиТОПАЗ.КассаККМ КАК КассаККМ,
	|	НастройкиЗагрузкиТОПАЗ.КассаКомпании КАК КассаКомпании,
	|	НастройкиЗагрузкиТОПАЗ.ДоговорРозничныйПоУмолчанию КАК ДоговорРозничныйПоУмолчанию,
	|	НастройкиЗагрузкиТОПАЗ.ТипЦен КАК ТипЦен,
	|	НастройкиЗагрузкиТОПАЗ.МенеджерПоУмолчанию КАК МенеджерПоУмолчанию,
	|	НастройкиЗагрузкиТОПАЗ.Инкассатор КАК Инкассатор,
	|	НастройкиЗагрузкиТОПАЗ.ДоговорИнкассации КАК ДоговорИнкассации,
	|	НастройкиЗагрузкиТОПАЗ.ПлатежнаяСистема КАК ПлатежнаяСистема,
	|	НастройкиЗагрузкиТОПАЗ.ДоговорПлатежнойСистемы КАК ДоговорПлатежнойСистемы,
	|	НастройкиЗагрузкиТОПАЗ.КаталогЗагрузки КАК КаталогЗагрузки
	|ИЗ
	|	РегистрСведений.НастройкиЗагрузкиТОПАЗ КАК НастройкиЗагрузкиТОПАЗ";
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Если Выборка.Следующий() Тогда
		Настройки.Вставить("Организация", Выборка.Организация);
		Настройки.Вставить("ПодразделениеКомпании", Выборка.ПодразделениеКомпании);
		Настройки.Вставить("СкладКомпании", Выборка.СкладКомпании);
		Настройки.Вставить("КассаККМ", Выборка.КассаККМ);
		Настройки.Вставить("КассаКомпании", Выборка.КассаКомпании);
		Настройки.Вставить("ДоговорРозничныйПоУмолчанию", Выборка.ДоговорРозничныйПоУмолчанию);
		Настройки.Вставить("ТипЦен", Выборка.ТипЦен);
		Настройки.Вставить("МенеджерПоУмолчанию", Выборка.МенеджерПоУмолчанию);
		Настройки.Вставить("Инкассатор", Выборка.Инкассатор);
		Настройки.Вставить("ДоговорИнкассации", Выборка.ДоговорИнкассации);
		Настройки.Вставить("ПлатежнаяСистема", Выборка.ПлатежнаяСистема);
		Настройки.Вставить("ДоговорПлатежнойСистемы", Выборка.ДоговорПлатежнойСистемы);
		Настройки.Вставить("КаталогЗагрузки", Выборка.КаталогЗагрузки);
	КонецЕсли;
	
	Возврат Настройки;
	
КонецФункции

// Находит контрагента по ИНН
//
// Параметры:
//  ИНН - Строка - ИНН контрагента
//
// Возвращаемое значение:
//  СправочникСсылка.Контрагенты - ссылка на контрагента, или Неопределено если не найден
//
Функция НайтиКонтрагентаПоИНН(ИНН) Экспорт
	
	Если ПустаяСтрока(ИНН) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Контрагенты.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|ГДЕ
	|	Контрагенты.ИНН = &ИНН";
	
	Запрос.УстановитьПараметр("ИНН", ИНН);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

// Находит номенклатуру по наименованию
//
// Параметры:
//  Наименование - Строка - наименование номенклатуры
//
// Возвращаемое значение:
//  СправочникСсылка.Номенклатура - ссылка на номенклатуру, или Неопределено если не найдена
//
Функция НайтиНоменклатуруПоНаименованию(Наименование) Экспорт
	
	Если ПустаяСтрока(Наименование) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Номенклатура.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.Наименование = &Наименование";
	
	Запрос.УстановитьПараметр("Наименование", Наименование);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

// Находит договор контрагента
//
// Параметры:
//  Контрагент - СправочникСсылка.Контрагенты - контрагент
//
// Возвращаемое значение:
//  СправочникСсылка.ДоговорыВзаиморасчетов - ссылка на договор, или Неопределено если не найден
//
Функция НайтиДоговорКонтрагента(Контрагент) Экспорт
	
	Если Контрагент = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ДоговорыВзаиморасчетов.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.ДоговорыВзаиморасчетов КАК ДоговорыВзаиморасчетов
	|ГДЕ
	|	ДоговорыВзаиморасчетов.Владелец = &Контрагент
	|	И ДоговорыВзаиморасчетов.ПометкаУдаления = ЛОЖЬ
	|
	|УПОРЯДОЧИТЬ ПО
	|	ДоговорыВзаиморасчетов.ДатаНачалаДействия УБЫВ";
	
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

// Рассчитывает сумму НДС
//
// Параметры:
//  Сумма - Число - сумма с НДС
//  СтавкаНДС - Число - ставка НДС в процентах (например, 20)
//
// Возвращаемое значение:
//  Число - сумма НДС
//
Функция РассчитатьСуммуНДС(Сумма, СтавкаНДС) Экспорт
	
	Если СтавкаНДС = 0 Тогда
		Возврат 0;
	КонецЕсли;
	
	Возврат Окр(Сумма * СтавкаНДС / (100 + СтавкаНДС), 2);
	
КонецФункции

// Определяет способ оплаты на основе сумм наличных и безналичных платежей
//
// Параметры:
//  AmountCash - Число - сумма наличными
//  AmountCashless - Число - сумма безналичными
//
// Возвращаемое значение:
//  Структура - структура с полями:
//   - СпособОплаты - ПеречислениеСсылка.СпособыОплаты - способ оплаты
//   - Сумма - Число - сумма оплаты
//
Функция ОпределитьСпособОплаты(AmountCash, AmountCashless) Экспорт
	
	Результат = Новый Структура;
	
	Если AmountCash > 0 И AmountCashless > 0 Тогда
		// Смешанная оплата - возвращаем оба способа
		Результат.Вставить("СпособОплаты", Перечисления.СпособыОплаты.Наличными);
		Результат.Вставить("Сумма", AmountCash);
		Результат.Вставить("СпособОплаты2", Перечисления.СпособыОплаты.ПлатежнойКартой);
		Результат.Вставить("Сумма2", AmountCashless);
	ИначеЕсли AmountCash > 0 Тогда
		Результат.Вставить("СпособОплаты", Перечисления.СпособыОплаты.Наличными);
		Результат.Вставить("Сумма", AmountCash);
	ИначеЕсли AmountCashless > 0 Тогда
		Результат.Вставить("СпособОплаты", Перечисления.СпособыОплаты.ПлатежнойКартой);
		Результат.Вставить("Сумма", AmountCashless);
	Иначе
		Результат.Вставить("СпособОплаты", Неопределено);
		Результат.Вставить("Сумма", 0);
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Находит контрагента "Частное Лицо" для розничных операций
//
// Возвращаемое значение:
//  СправочникСсылка.Контрагенты - ссылка на контрагента "Частное Лицо", или Неопределено если не найден
//
Функция НайтиКонтрагентаЧастноеЛицо() Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Контрагенты.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|ГДЕ
	|	Контрагенты.Наименование = &Наименование";
	
	Запрос.УстановитьПараметр("Наименование", "Частное Лицо");
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

#КонецОбласти

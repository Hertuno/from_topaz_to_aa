# Расширение конфигурации "1С:Альфа-Авто 6.1" для загрузки данных из ТОПАЗ

## Описание

Расширение предназначено для автоматизированной загрузки данных о реализации топлива и товаров из системы ТОПАЗ в 1С:Альфа-Авто 6.1 с автоматическим формированием документов учета.

### Основные возможности

- Автоматическая загрузка данных из XML файлов ТОПАЗ
- **Агрегация розничных операций:** все операции за день объединяются в одну реализацию
- Обработка продажи топлива (OutcomesByRetail)
- Обработка продажи товаров (ItemOutcomesByRetail)
- Обработка операций по топливным картам (OutcomesByOffice)
- Автоматическое формирование документов:
  - **За день по топливу:** одна Реализация товаров, один Чек, одна Инкассация, один ПКО (если есть наличные)
  - **За день по товарам:** одна Реализация товаров (сопутствующие товары)
  - **По топливным картам:** индивидуальные документы по каждой операции
  - **Счет-фактура выданный:** создаётся только по итоговой реализации за месяц
- Автоматический запуск ежедневно в 23:50
- Возможность ручного запуска загрузки с указанием даты

### Логика агрегации

**За день (все смены):**
- Все операции `OutcomeByRetail` (кроме "Топливная карта") → **один** комплект документов по топливу
- Все операции `ItemOutcomesByRetail` → **один** документ реализации товаров
- Агрегация по виду топлива (`FuelName`) и по товару (`ItemCode`)
- Суммирование количеств и сумм, расчёт средневзвешенных цен

**Счета-фактуры:**
- Ежедневно **НЕ создаются**
- Создаются **только по итоговой реализации за месяц** (при обработке последнего дня месяца)

---

## Требования

- Конфигурация: 1С:Альфа-Авто 6.1
- Формат файлов: XML (кодировка Windows-1251)
- Имя файла: `CloseSession_ГГГГ-ММ-ДД_ЧЧ-ММ-СС.xml` или `CloseSession_ГГГГ-ММ-ДД*.xml`
- Версия формата ТОПАЗ: 3.15

---

## Настройка перед тестированием

### 1. Заполнение регистра сведений "Настройки загрузки ТОПАЗ"

**Путь:** Регистры сведений → Настройки загрузки ТОПАЗ

**Обязательные настройки:**

| Поле | Описание | Пример |
|------|----------|--------|
| **Организация** | Организация для документов | Авангард |
| **Подразделение компании** | Подразделение для документов | Авангард |
| **Склад компании** | Склад для реализации | КПГ |
| **Касса ККМ** | Касса контрольно-кассовой машины | Касса Авангард |
| **Касса компании** | Главная касса компании | Касса (RUB) |
| **Договор розничный по умолчанию** | Договор для розничных операций | Розничная продажа |
| **Тип цен** | Тип цен для документов | Основной тип цен продажи |
| **Менеджер по умолчанию** | Менеджер для документов | (любой сотрудник) |
| **Инкассатор** | Контрагент-инкассатор | (контрагент) |
| **Договор инкассации** | Договор для инкассации | Инкассация АВ в RUB |
| **Платежная система** | Контрагент-платежная система | БАНК РУССКИЙ СТАНДАРТ АО |
| **Договор платежной системы** | Договор с платежной системой | Терминал АВ |
| **Каталог загрузки** | Путь к каталогу с XML файлами | `\\sr-agnks-topaz\1` |

**Важно:** Все поля должны быть заполнены, иначе загрузка не запустится.

### 2. Проверка наличия справочников

Убедитесь, что в базе данных существуют:

- **Контрагенты:**
  - Контрагент с наименованием "Частное Лицо" (для розничных операций)
  - Контрагенты с заполненным ИНН (для операций по топливным картам)
  
- **Номенклатура:**
  - Номенклатура с наименованиями, соответствующими `FuelName` из XML файлов (например, "КПГ", "АИ-95" и т.д.)

- **Договоры взаиморасчетов:**
  - Договоры для контрагентов с топливными картами

### 3. Подготовка тестовых XML файлов

Создайте каталог для загрузки (например, `\\sr-agnks-topaz\1`) и поместите туда тестовые XML файлы.

**Формат имени файла:** `CloseSession_2024-01-15_23-50-00.xml` или `CloseSession_2024-01-15*.xml`

---

## Инструкции по тестированию

### Тест 1: Ручной запуск загрузки

**Цель:** Проверить возможность ручного запуска загрузки и обработку розничных операций.

**Шаги:**

1. Откройте обработку **"Загрузка данных из ТОПАЗ"**
   - Путь: Обработки → Загрузка данных из ТОПАЗ

2. Убедитесь, что в каталоге загрузки есть XML файл за выбранную дату

3. Нажмите кнопку **"Выполнить загрузку"** (если есть форма) или запустите обработку

4. Проверьте результат:
   - Должно появиться сообщение об успешной обработке
   - Проверьте журнал регистрации (Сервис → Журнал регистрации) на наличие записей

**Что проверить после загрузки:**

**По топливу (OutcomesByRetail):**
- ✅ Создан **ОДИН** документ "Реализация товаров" за день (контрагент "Частное Лицо", комментарий "Розничная реализация топлива за день")
- ✅ В табличной части "Товары" — агрегированные данные по каждому виду топлива из всех смен за день
- ✅ Создан **ОДИН** документ "Чек на оплату"
- ✅ В "Оплаты" чека — итоговые суммы наличных и/или безналичных за день
- ✅ Создан **ОДИН** документ "Инкассация"
- ✅ Создан **ОДИН** документ "Приходный кассовый ордер" (только если за день были наличные)
- ✅ **НЕ создан** документ "Счет-фактура выданный" (создаётся только в конце месяца)

**По товарам (ItemOutcomesByRetail):**
- ✅ Создан **ОДИН** документ "Реализация товаров" за день по сопутствующим товарам (комментарий "Розничная реализация товаров за день")
- ✅ В табличной части — агрегированные данные по каждому товару из всех смен за день

**По топливным картам (OutcomesByOffice):**
- ✅ Созданы индивидуальные документы "Реализация товаров" и "Счет-фактура выданный" по каждой операции

**Общее:**
- ✅ Все документы проведены
- ✅ Суммы в документах соответствуют итогам из XML файлов за день
- ✅ Способ оплаты "Простая скидка" отображается как наличный расчёт

### Тест 2: Агрегация операций за день (несколько смен)

**Цель:** Проверить объединение операций из нескольких файлов (утренняя и вечерняя смена) в один комплект документов.

**Подготовка:**

1. Подготовьте 2 XML файла за одну дату (например, `CloseSession_2026-01-30_07-44-51.xml` и `CloseSession_2026-01-30_19-47-49.xml`)
2. В каждом файле должны быть операции `OutcomeByRetail` с разными видами топлива

**Ожидаемый результат:**

- Создан **ОДИН** документ "Реализация товаров" за день
- В табличной части — агрегированные данные по топливу из обоих файлов
- Количества и суммы — суммы из обеих смен
- Цены — средневзвешенные
- Один комплект документов: Чек, Инкассация, ПКО

### Тест 3: Обработка "Простая скидка" как наличной оплаты

**Цель:** Проверить, что "Простая скидка" обрабатывается как наличная оплата.

**Подготовка:**

1. Найдите в XML файле операцию с `PaymentModeName="Простая скидка"`
2. Проверьте, что в ней указаны `AmountCash` и `AmountCashless`

**Ожидаемый результат:**

- В документе "Чек на оплату" способ оплаты определён по полям `AmountCash` и `AmountCashless`
- Если `AmountCash > 0` — способ оплаты "Наличные"
- "Простая скидка" считается наличной оплатой

### Тест 4: Обработка продажи товаров (ItemOutcomesByRetail)

**Цель:** Проверить создание документа реализации товаров из блока ItemOutcomesByRetail.

**Подготовка:**

1. Убедитесь, что в XML файлах есть блок `ItemOutcomesByRetail` с элементами `ItemOutcomeByRetail`
2. Проверьте наличие номенклатуры в базе по коду (`ItemCode`) или наименованию (`ItemName`)

**Ожидаемый результат:**

- Создан **ОДИН** документ "Реализация товаров" за день по товарам
- В табличной части — агрегированные данные по каждому товару
- Контрагент — "Частное Лицо"
- Ставки НДС взяты из атрибута `Nds`

### Тест 5: Обработка операций по топливным картам

**Цель:** Проверить создание документов для операций по топливным картам.

**Подготовка:**

1. Убедитесь, что в XML файлах есть блок `OutcomesByOffice` с `PartnerINN`
2. Убедитесь, что контрагенты с указанными ИНН существуют в базе

**Ожидаемый результат:**

- Создан отдельный документ "Реализация товаров" для **каждой** операции по топливной карте
- Контрагент определён по ИНН
- Создан документ "Счет-фактура выданный" для каждой операции
- **НЕ созданы** документы "Чек на оплату" и "Инкассация" (только для розницы)

### Тест 6: Обработка смешанной оплаты (наличные + безналичные)

**Цель:** Проверить агрегацию операций с разными способами оплаты за день.

**Подготовка:**

1. Убедитесь, что за день есть операции с `AmountCash > 0` и операции с `AmountCashless > 0`

**Ожидаемый результат:**

- Создан один документ "Чек на оплату" с двумя строками в табличной части "Оплаты":
  - Строка 1: Тип оплаты "Наличные", сумма = сумма всех AmountCash за день
  - Строка 2: Тип оплаты "Электронно", сумма = сумма всех AmountCashless за день

### Тест 7: Счёт-фактура только по итогу месяца

**Цель:** Проверить, что счета-фактуры не создаются ежедневно.

**Шаги:**

1. Запустите загрузку за обычный день месяца (не последний)
2. Проверьте созданные документы

**Ожидаемый результат:**

- Для розничной реализации топлива **НЕ создан** документ "Счет-фактура выданный"
- Счета-фактуры создаются только при обработке последнего дня месяца (для итоговой реализации)

### Тест 8: Автоматический запуск (регламентное задание)

**Цель:** Проверить работу автоматического запуска.

**Шаги:**

1. Убедитесь, что регламентное задание "Загрузка данных из ТОПАЗ" включено
   - Путь: Администрирование → Регламентные задания
   - Проверьте, что задание активно и расписание установлено на 23:50

2. Поместите XML файл в каталог загрузки

3. Дождитесь времени запуска или запустите задание вручную (если возможно)

**Ожидаемый результат:**

- Загрузка выполнилась автоматически
- В журнале регистрации есть записи о выполнении

### Тест 9: Обработка ошибок

**Цель:** Проверить обработку различных ошибок.

**Тестовые сценарии:**

1. **Отсутствие настроек:**
   - Очистите регистр сведений "Настройки загрузки ТОПАЗ"
   - Запустите загрузку
   - **Ожидаемый результат:** Сообщение об ошибке "Настройки загрузки не заполнены"

2. **Несуществующий каталог:**
   - Укажите несуществующий путь в настройках
   - Запустите загрузку
   - **Ожидаемый результат:** Сообщение об ошибке при попытке найти файлы

3. **Отсутствие контрагента:**
   - Создайте XML с топливной картой, где ИНН не существует в базе
   - Запустите загрузку
   - **Ожидаемый результат:** Ошибка в журнале регистрации, операция пропущена, остальные обработаны

4. **Отсутствие номенклатуры:**
   - Создайте XML с `FuelName`, которого нет в справочнике номенклатуры
   - Запустите загрузку
   - **Ожидаемый результат:** Ошибка в журнале регистрации, операция пропущена

---

## Проверка результатов загрузки

### 1. Проверка документов

После выполнения загрузки проверьте созданные документы:

**Документы → Реализация товаров:**
- Фильтр по дате загрузки
- Проверьте количество, суммы, контрагентов

**Документы → Чек на оплату:**
- Проверьте связь с документом "Реализация товаров"
- Проверьте способы оплаты и суммы

**Документы → Инкассация:**
- Проверьте суммы и способы оплаты

**Документы → Приходный кассовый ордер:**
- Проверьте наличие только для наличных операций

**Документы → Счет-фактура выданный:**
- Проверьте связь с документом "Реализация товаров"

### 2. Проверка журнала регистрации

**Путь:** Сервис → Журнал регистрации

**Фильтр:** Событие = "ЗагрузкаТОПАЗ"

**Что проверить:**

- ✅ Есть записи об успешной обработке файлов
- ✅ Нет критических ошибок (только предупреждения о пропущенных операциях)
- ✅ Записи содержат понятные сообщения

### 3. Проверка сумм и количеств

Сравните данные из XML файлов с созданными документами:

- Объемы (`Volume`) соответствуют количеству в документах
- Суммы (`Amount`) соответствуют суммам в документах
- Цены (`OrigPrice`) соответствуют ценам в документах
- НДС рассчитан корректно (20% от суммы с НДС)

---

## Пример структуры XML файла

```xml
<?xml version="1.0" encoding="windows-1251"?>
<DataPaket Version="3.15" DateTime="30.01.2026 19:47:45" Type="Aggregated" AZSCode="1">
    <Sessions>
        <Session SessionNum="284" StartDateTime="30.01.2026 7:44:55" 
                 EndDateTime="30.01.2026 19:47:04" UserName="Яковлев М.В">
            
            <!-- Розничные продажи топлива -->
            <OutcomesByRetail>
                <!-- Простая скидка (наличный расчёт) -->
                <OutcomeByRetail TankNum="1" HoseName="3" FuelName="КПГ" 
                                 PaymentModeName="Простая скидка" Volume="15,91" 
                                 Amount="385,02" OrigPrice="25,2" 
                                 AmountCash="600" AmountCashless="0" OrderCount="1"/>
                
                <!-- Терминал (безналичный расчёт) -->
                <OutcomeByRetail TankNum="1" HoseName="3" FuelName="КПГ" 
                                 PaymentModeName="Терминал" Volume="10,29" 
                                 Amount="259,31" OrigPrice="25,2" 
                                 AmountCash="259,31" AmountCashless="0" OrderCount="1"/>
                
                <!-- Топливная карта в розничном блоке - пропускается -->
                <OutcomeByRetail TankNum="1" HoseName="1" FuelName="КПГ" 
                                 PaymentModeName="Топливная карта" 
                                 OfficeCardCode="9DF33C3F6D" Volume="453,06" 
                                 Amount="9605,41" AmountCash="9605,41" 
                                 AmountCashless="0" OrderCount="3"/>
            </OutcomesByRetail>
            
            <!-- Продажа товаров -->
            <ItemOutcomesByRetail>
                <ItemOutcomeByRetail ItemName="Зажигалка ПЬЕЗО-ЗАЖИГАЛКА DA-011 Delta Phantom" 
                                     ItemCode="6976772760036" PaymentModeName="Терминал" 
                                     Quantity="1" Amount="44" Nds="22%" Unit="шт" 
                                     IsReturn="0" PriceRetail="44"/>
                
                <ItemOutcomeByRetail ItemName="Сигареты Ява Белое Золото Класс." 
                                     ItemCode="46233554" PaymentModeName="Терминал" 
                                     Quantity="1" Amount="160" Nds="22%" Unit="пач" 
                                     IsReturn="0" PriceRetail="0"/>
            </ItemOutcomesByRetail>
            
            <!-- Продажи по топливным картам -->
            <OutcomesByOffice>
                <OutcomeByOffice Date="30.01.2026" Time="8:34:34" TankNum="1" 
                                 HoseName="3" FuelName="КПГ" 
                                 PaymentModeName="Топливная карта" 
                                 Volume="258,94" Amount="5567,21" OrigPrice="25,2">
                    <CardCode>E0F23D3F10</CardCode>
                    <PartnerName>АО "Тобольское ПАТП"</PartnerName>
                    <PartnerINN>7206017177</PartnerINN>
                    <LimitCard_CarName>YUTONG ZK6128HN</LimitCard_CarName>
                    <LimitCard_CarNumber>1405</LimitCard_CarNumber>
                </OutcomeByOffice>
            </OutcomesByOffice>
            
        </Session>
    </Sessions>
</DataPaket>
```

**Важно:** Структура реального XML файла использует вложенность `DataPaket → Sessions → Session → блоки операций`

---

## Возможные проблемы и решения

### Проблема: "Настройки загрузки не заполнены"

**Решение:** Заполните все обязательные поля в регистре сведений "Настройки загрузки ТОПАЗ"

### Проблема: "Не найден контрагент 'Частное Лицо'"

**Решение:** Создайте контрагента с наименованием "Частное Лицо" в справочнике "Контрагенты"

### Проблема: "Не найдена номенклатура: [наименование]"

**Решение:** 
- Проверьте наименование топлива в XML (`FuelName`)
- Создайте номенклатуру с таким же наименованием в справочнике "Номенклатура"

### Проблема: "Не найден контрагент с ИНН: [ИНН]"

**Решение:** 
- Проверьте ИНН в XML (`PartnerINN`)
- Создайте контрагента с таким ИНН или исправьте ИНН в XML

### Проблема: "Не найден договор для контрагента"

**Решение:** Создайте договор взаиморасчетов для контрагента с топливной картой

### Проблема: Файлы не обрабатываются

**Решение:**
- Проверьте путь к каталогу загрузки в настройках
- Убедитесь, что файлы имеют правильное имя: `CloseSession_ГГГГ-ММ-ДД*.xml`
- Проверьте права доступа к каталогу

### Проблема: Документы не проводятся

**Решение:**
- Проверьте настройки документов (обязательные поля)
- Проверьте права пользователя на проведение документов
- Проверьте журнал регистрации на наличие ошибок

---

## Контакты для вопросов

При возникновении проблем или вопросов обращайтесь к разработчику расширения.

---

## Дополнительная информация

Подробное техническое задание находится в файле `ТЕХНИЧЕСКОЕ ЗАДАНИЕ.md`.

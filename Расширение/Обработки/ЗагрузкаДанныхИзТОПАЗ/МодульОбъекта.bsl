#Область СлужебныйПрограммныйИнтерфейс

// Выполняет загрузку данных из XML файлов ТОПАЗ
//
Процедура ВыполнитьЗагрузку() Экспорт
	
	Попытка
		
		Настройки = ЗагрузкаТОПАЗОбщий.ПолучитьНастройки();
		
		Если Настройки.Количество() = 0 Тогда
			ВызватьИсключение "Настройки загрузки не заполнены. Заполните регистр сведений НастройкиЗагрузкиТОПАЗ.";
		КонецЕсли;
		
		КаталогЗагрузки = Настройки.КаталогЗагрузки;
		
		Если ПустаяСтрока(КаталогЗагрузки) Тогда
			ВызватьИсключение "Не указан каталог загрузки в настройках.";
		КонецЕсли;
		
		Если Не КаталогСуществует(КаталогЗагрузки) Тогда
			ВызватьИсключение "Каталог загрузки не существует: " + КаталогЗагрузки;
		КонецЕсли;
		
		// Поиск XML файлов за текущие сутки
		ТекущаяДата = ТекущаяДата();
		НачалоСуток = НачалоДня(ТекущаяДата);
		КонецСуток = КонецДня(ТекущаяДата);
		
		МаскаФайла = "CloseSession_*.xml";
		НайденныеФайлы = НайтиФайлы(КаталогЗагрузки, МаскаФайла);
		
		ОбработанныеФайлы = 0;
		Ошибки = Новый Массив;
		
		Для Каждого ПутьКФайлу Из НайденныеФайлы Цикл
			
			Попытка
				
				ДатаФайла = ПолучитьДатуИзмененияФайла(ПутьКФайлу);
				
				// Обрабатываем только файлы за текущие сутки
				Если ДатаФайла >= НачалоСуток И ДатаФайла <= КонецСуток Тогда
					
					ОбработатьФайл(ПутьКФайлу, Настройки);
					ОбработанныеФайлы = ОбработанныеФайлы + 1;
					
					ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
						УровеньЖурналаРегистрации.Информация, , , 
						"Файл успешно обработан: " + ПутьКФайлу);
					
				КонецЕсли;
				
			Исключение
				
				ТекстОшибки = ОписаниеОшибки();
				Ошибки.Добавить("Ошибка при обработке файла " + ПутьКФайлу + ": " + ТекстОшибки);
				
				ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
					УровеньЖурналаРегистрации.Ошибка, , , 
					"Ошибка при обработке файла " + ПутьКФайлу + ": " + ТекстОшибки);
				
			КонецПопытки;
			
		КонецЦикла;
		
		// Проверка последнего дня месяца
		Если День(КонецМесяца(ТекущаяДата)) = День(ТекущаяДата) Тогда
			
			Попытка
				ОбработатьПоследнийДеньМесяца(Настройки);
			Исключение
				ТекстОшибки = ОписаниеОшибки();
				Ошибки.Добавить("Ошибка при обработке последнего дня месяца: " + ТекстОшибки);
				
				ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
					УровеньЖурналаРегистрации.Ошибка, , , 
					"Ошибка при обработке последнего дня месяца: " + ТекстОшибки);
			КонецПопытки;
			
		КонецЕсли;
		
		ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
			УровеньЖурналаРегистрации.Информация, , , 
			"Загрузка завершена. Обработано файлов: " + ОбработанныеФайлы);
		
	Исключение
		
		ТекстОшибки = ОписаниеОшибки();
		ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
			УровеньЖурналаРегистрации.Ошибка, , , 
			"Критическая ошибка при выполнении загрузки: " + ТекстОшибки);
		
		ВызватьИсключение ТекстОшибки;
		
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Обрабатывает один XML файл
//
// Параметры:
//  ПутьКФайлу - Строка - полный путь к XML файлу
//  Настройки - Структура - настройки загрузки
//
Процедура ОбработатьФайл(ПутьКФайлу, Настройки)
	
	Попытка
		
		// Извлечение данных сессии
		ДанныеСессии = ИзвлечьДанныеСессии(ПутьКФайлу);
		
		// Определение даты документа (дата файла + время 23:50)
		ДатаДокумента = НачалоДня(ДанныеСессии.ДатаФайла);
		ДатаДокумента = ДатаДокумента + Время(23, 50, 0);
		
		// Обработка розничных операций (OutcomeByRetail)
		ОперацииРозницы = ИзвлечьОперацииРозницы(ПутьКФайлу);
		
		Для Каждого Операция Из ОперацииРозницы Цикл
			
			Попытка
				СоздатьДокументыРозницы(Операция, ДатаДокумента, Настройки, ДанныеСессии);
			Исключение
				ТекстОшибки = ОписаниеОшибки();
				ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
					УровеньЖурналаРегистрации.Ошибка, , , 
					"Ошибка при создании документов розницы: " + ТекстОшибки);
			КонецПопытки;
			
		КонецЦикла;
		
		// Обработка операций по топливным картам (OutcomeByOffice)
		ОперацииТопливныхКарт = ИзвлечьОперацииТопливныхКарт(ПутьКФайлу);
		
		Для Каждого Операция Из ОперацииТопливныхКарт Цикл
			
			Попытка
				СоздатьДокументыТопливныхКарт(Операция, ДатаДокумента, Настройки, ДанныеСессии);
			Исключение
				ТекстОшибки = ОписаниеОшибки();
				ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
					УровеньЖурналаРегистрации.Ошибка, , , 
					"Ошибка при создании документов по топливным картам: " + ТекстОшибки);
			КонецПопытки;
			
		КонецЦикла;
		
	Исключение
		
		ТекстОшибки = ОписаниеОшибки();
		ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
			УровеньЖурналаРегистрации.Ошибка, , , 
			"Критическая ошибка при обработке файла " + ПутьКФайлу + ": " + ТекстОшибки);
		
		ВызватьИсключение;
		
	КонецПопытки;
	
КонецПроцедуры

// Читает и парсит XML файл с кодировкой windows-1251
//
// Параметры:
//  ПутьКФайлу - Строка - полный путь к XML файлу
//
// Возвращаемое значение:
//  XMLReader - объект чтения XML, или Неопределено при ошибке
//
Функция ПрочитатьXML(ПутьКФайлу)
	
	Попытка
		
		Если Не ФайлСуществует(ПутьКФайлу) Тогда
			ВызватьИсключение "Файл не найден: " + ПутьКФайлу;
		КонецЕсли;
		
		// Чтение и парсинг XML с кодировкой windows-1251
		ЧтениеXML = Новый ЧтениеXML;
		ЧтениеXML.ОткрытьФайл(ПутьКФайлу, КодировкаТекста.Windows1251);
		
		Возврат ЧтениеXML;
		
	Исключение
		
		ТекстОшибки = ОписаниеОшибки();
		ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
			УровеньЖурналаРегистрации.Ошибка, , , 
			"Ошибка при чтении XML файла " + ПутьКФайлу + ": " + ТекстОшибки);
		
		Возврат Неопределено;
		
	КонецПопытки;
	
КонецФункции

// Извлекает данные сессии из XML
//
// Параметры:
//  ПутьКФайлу - Строка - полный путь к XML файлу
//
// Возвращаемое значение:
//  Структура - структура с данными сессии
//
Функция ИзвлечьДанныеСессии(ПутьКФайлу)
	
	ДанныеСессии = Новый Структура;
	ЧтениеXML = Неопределено;
	
	Попытка
		
		ЧтениеXML = ПрочитатьXML(ПутьКФайлу);
		
		Если ЧтениеXML = Неопределено Тогда
			ВызватьИсключение "Не удалось открыть XML файл: " + ПутьКФайлу;
		КонецЕсли;
		
		// Поиск корневого элемента DataPaket
		Пока ЧтениеXML.Прочитать() Цикл
			
			Если ЧтениеXML.ИмяЭлемента = "DataPaket" И ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
				
				// Извлечение атрибутов DataPaket
				ДанныеСессии.Вставить("Version", ЧтениеXML.ЗначениеАтрибута("Version"));
				ДанныеСессии.Вставить("DateTime", ЧтениеXML.ЗначениеАтрибута("DateTime"));
				ДанныеСессии.Вставить("Type", ЧтениеXML.ЗначениеАтрибута("Type"));
				ДанныеСессии.Вставить("AZSCode", ЧтениеXML.ЗначениеАтрибута("AZSCode"));
				
				// Парсинг даты и времени
				СтрокаДатыВремени = Строка(ДанныеСессии.DateTime);
				Попытка
					ДанныеСессии.Вставить("ДатаФайла", Дата(СтрокаДатыВремени));
				Исключение
					ДанныеСессии.Вставить("ДатаФайла", ТекущаяДата());
				КонецПопытки;
				
				// Поиск элемента Session
				Пока ЧтениеXML.Прочитать() Цикл
					
					Если ЧтениеXML.ИмяЭлемента = "Session" И ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
						
						ДанныеСессии.Вставить("SessionNum", ЧтениеXML.ЗначениеАтрибута("SessionNum"));
						ДанныеСессии.Вставить("StartDateTime", ЧтениеXML.ЗначениеАтрибута("StartDateTime"));
						ДанныеСессии.Вставить("EndDateTime", ЧтениеXML.ЗначениеАтрибута("EndDateTime"));
						ДанныеСессии.Вставить("UserName", ЧтениеXML.ЗначениеАтрибута("UserName"));
						
						Прервать;
						
					КонецЕсли;
					
				КонецЦикла;
				
				Прервать;
				
			КонецЕсли;
			
		КонецЦикла;
		
		// Закрытие чтения XML
		ЧтениеXML.Закрыть();
		
	Исключение
		
		ТекстОшибки = ОписаниеОшибки();
		ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
			УровеньЖурналаРегистрации.Ошибка, , , 
			"Ошибка при извлечении данных сессии: " + ТекстОшибки);
		
		Если ЧтениеXML <> Неопределено Тогда
			Попытка
				ЧтениеXML.Закрыть();
			Исключение
			КонецПопытки;
		КонецЕсли;
		
		ВызватьИсключение;
		
	КонецПопытки;
	
	Возврат ДанныеСессии;
	
КонецФункции

// Извлекает операции розницы (OutcomeByRetail) из XML
//
// Параметры:
//  ПутьКФайлу - Строка - полный путь к XML файлу
//
// Возвращаемое значение:
//  Массив - массив структур с данными операций
//
Функция ИзвлечьОперацииРозницы(ПутьКФайлу)
	
	Операции = Новый Массив;
	ЧтениеXML = Неопределено;
	
	Попытка
		
		ЧтениеXML = ПрочитатьXML(ПутьКФайлу);
		
		Если ЧтениеXML = Неопределено Тогда
			Возврат Операции;
		КонецЕсли;
		
		ВБлокеOutcomeByRetail = Ложь;
		
		// Поиск блока OutcomeByRetail и извлечение операций
		Пока ЧтениеXML.Прочитать() Цикл
			
			Если ЧтениеXML.ИмяЭлемента = "OutcomeByRetail" И ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
				ВБлокеOutcomeByRetail = Истина;
			ИначеЕсли ЧтениеXML.ИмяЭлемента = "OutcomeByRetail" И ЧтениеXML.ТипУзла = ТипУзлаXML.КонецЭлемента Тогда
				ВБлокеOutcomeByRetail = Ложь;
			ИначеЕсли ВБлокеOutcomeByRetail И ЧтениеXML.ИмяЭлемента = "Item" И ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
				
				Операция = Новый Структура;
				Операция.Вставить("TankNum", ЧтениеXML.ЗначениеАтрибута("TankNum"));
				Операция.Вставить("HoseName", ЧтениеXML.ЗначениеАтрибута("HoseName"));
				Операция.Вставить("FuelName", ЧтениеXML.ЗначениеАтрибута("FuelName"));
				Операция.Вставить("PaymentModeName", ЧтениеXML.ЗначениеАтрибута("PaymentModeName"));
				
				Попытка
					Операция.Вставить("Volume", Число(ЧтениеXML.ЗначениеАтрибута("Volume")));
				Исключение
					Операция.Вставить("Volume", 0);
				КонецПопытки;
				
				Попытка
					Операция.Вставить("Amount", Число(ЧтениеXML.ЗначениеАтрибута("Amount")));
				Исключение
					Операция.Вставить("Amount", 0);
				КонецПопытки;
				
				Попытка
					Операция.Вставить("OrigPrice", Число(ЧтениеXML.ЗначениеАтрибута("OrigPrice")));
				Исключение
					Операция.Вставить("OrigPrice", 0);
				КонецПопытки;
				
				Попытка
					Операция.Вставить("AmountCash", Число(ЧтениеXML.ЗначениеАтрибута("AmountCash")));
				Исключение
					Операция.Вставить("AmountCash", 0);
				КонецПопытки;
				
				Попытка
					Операция.Вставить("AmountCashless", Число(ЧтениеXML.ЗначениеАтрибута("AmountCashless")));
				Исключение
					Операция.Вставить("AmountCashless", 0);
				КонецПопытки;
				
				Попытка
					Операция.Вставить("OrderCount", Число(ЧтениеXML.ЗначениеАтрибута("OrderCount")));
				Исключение
					Операция.Вставить("OrderCount", 0);
				КонецПопытки;
				
				// Фильтр: только не топливные карты
				Если Строка(Операция.PaymentModeName) <> "Топливная карта" Тогда
					Операции.Добавить(Операция);
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЦикла;
		
		ЧтениеXML.Закрыть();
		
	Исключение
		
		ТекстОшибки = ОписаниеОшибки();
		ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
			УровеньЖурналаРегистрации.Ошибка, , , 
			"Ошибка при извлечении операций розницы: " + ТекстОшибки);
		
		Если ЧтениеXML <> Неопределено Тогда
			Попытка
				ЧтениеXML.Закрыть();
			Исключение
			КонецПопытки;
		КонецЕсли;
		
	КонецПопытки;
	
	Возврат Операции;
	
КонецФункции

// Извлекает операции по топливным картам (OutcomeByOffice) из XML
//
// Параметры:
//  ПутьКФайлу - Строка - полный путь к XML файлу
//
// Возвращаемое значение:
//  Массив - массив структур с данными операций
//
Функция ИзвлечьОперацииТопливныхКарт(ПутьКФайлу)
	
	Операции = Новый Массив;
	ЧтениеXML = Неопределено;
	
	Попытка
		
		ЧтениеXML = ПрочитатьXML(ПутьКФайлу);
		
		Если ЧтениеXML = Неопределено Тогда
			Возврат Операции;
		КонецЕсли;
		
		ВБлокеOutcomeByOffice = Ложь;
		
		// Поиск блока OutcomeByOffice и извлечение операций
		Пока ЧтениеXML.Прочитать() Цикл
			
			Если ЧтениеXML.ИмяЭлемента = "OutcomeByOffice" И ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
				ВБлокеOutcomeByOffice = Истина;
			ИначеЕсли ЧтениеXML.ИмяЭлемента = "OutcomeByOffice" И ЧтениеXML.ТипУзла = ТипУзлаXML.КонецЭлемента Тогда
				ВБлокеOutcomeByOffice = Ложь;
			ИначеЕсли ВБлокеOutcomeByOffice И ЧтениеXML.ИмяЭлемента = "Item" И ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
				
				Операция = Новый Структура;
				Операция.Вставить("Date", ЧтениеXML.ЗначениеАтрибута("Date"));
				Операция.Вставить("Time", ЧтениеXML.ЗначениеАтрибута("Time"));
				Операция.Вставить("TankNum", ЧтениеXML.ЗначениеАтрибута("TankNum"));
				Операция.Вставить("HoseName", ЧтениеXML.ЗначениеАтрибута("HoseName"));
				Операция.Вставить("FuelName", ЧтениеXML.ЗначениеАтрибута("FuelName"));
				Операция.Вставить("PaymentModeName", ЧтениеXML.ЗначениеАтрибута("PaymentModeName"));
				
				Попытка
					Операция.Вставить("Volume", Число(ЧтениеXML.ЗначениеАтрибута("Volume")));
				Исключение
					Операция.Вставить("Volume", 0);
				КонецПопытки;
				
				Попытка
					Операция.Вставить("Amount", Число(ЧтениеXML.ЗначениеАтрибута("Amount")));
				Исключение
					Операция.Вставить("Amount", 0);
				КонецПопытки;
				
				Попытка
					Операция.Вставить("OrigPrice", Число(ЧтениеXML.ЗначениеАтрибута("OrigPrice")));
				Исключение
					Операция.Вставить("OrigPrice", 0);
				КонецПопытки;
				
				Попытка
					Операция.Вставить("AmountTotal", Число(ЧтениеXML.ЗначениеАтрибута("AmountTotal")));
				Исключение
					Операция.Вставить("AmountTotal", 0);
				КонецПопытки;
				
				// Дочерние элементы (читаем текст узлов)
				Операция.Вставить("CardCode", "");
				Операция.Вставить("PartnerName", "");
				Операция.Вставить("PartnerINN", "");
				Операция.Вставить("LimitCard_CarName", "");
				Операция.Вставить("LimitCard_CarNumber", "");
				
				// Чтение дочерних элементов
				Пока ЧтениеXML.Прочитать() Цикл
					
					Если ЧтениеXML.ТипУзла = ТипУзлаXML.КонецЭлемента И ЧтениеXML.ИмяЭлемента = "Item" Тогда
						Прервать;
					ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.Текст И ЧтениеXML.ИмяЭлемента = "CardCode" Тогда
						Операция.CardCode = СокрЛП(ЧтениеXML.Значение);
					ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.Текст И ЧтениеXML.ИмяЭлемента = "PartnerName" Тогда
						Операция.PartnerName = СокрЛП(ЧтениеXML.Значение);
					ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.Текст И ЧтениеXML.ИмяЭлемента = "PartnerINN" Тогда
						Операция.PartnerINN = СокрЛП(ЧтениеXML.Значение);
					ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.Текст И ЧтениеXML.ИмяЭлемента = "LimitCard_CarName" Тогда
						Операция.LimitCard_CarName = СокрЛП(ЧтениеXML.Значение);
					ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.Текст И ЧтениеXML.ИмяЭлемента = "LimitCard_CarNumber" Тогда
						Операция.LimitCard_CarNumber = СокрЛП(ЧтениеXML.Значение);
					КонецЕсли;
					
				КонецЦикла;
				
				// Фильтр: только топливные карты с ИНН
				Если Строка(Операция.PaymentModeName) = "Топливная карта" 
					И Не ПустаяСтрока(Строка(Операция.PartnerINN)) Тогда
					Операции.Добавить(Операция);
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЦикла;
		
		ЧтениеXML.Закрыть();
		
	Исключение
		
		ТекстОшибки = ОписаниеОшибки();
		ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
			УровеньЖурналаРегистрации.Ошибка, , , 
			"Ошибка при извлечении операций по топливным картам: " + ТекстОшибки);
		
		Если ЧтениеXML <> Неопределено Тогда
			Попытка
				ЧтениеXML.Закрыть();
			Исключение
			КонецПопытки;
		КонецЕсли;
		
	КонецПопытки;
	
	Возврат Операции;
	
КонецФункции

// Создает документы для розничных операций
//
// Параметры:
//  Операция - Структура - данные операции
//  ДатаДокумента - Дата - дата создания документов
//  Настройки - Структура - настройки загрузки
//  ДанныеСессии - Структура - данные сессии
//
Процедура СоздатьДокументыРозницы(Операция, ДатаДокумента, Настройки, ДанныеСессии)
	
	НачатьТранзакцию();
	
	Попытка
		
		// Поиск контрагента "Частное Лицо"
		Контрагент = ЗагрузкаТОПАЗОбщий.НайтиКонтрагентаЧастноеЛицо();
		
		Если Контрагент = Неопределено Тогда
			ВызватьИсключение "Не найден контрагент 'Частное Лицо'";
		КонецЕсли;
		
		// Поиск номенклатуры
		Номенклатура = ЗагрузкаТОПАЗОбщий.НайтиНоменклатуруПоНаименованию(Операция.FuelName);
		
		Если Номенклатура = Неопределено Тогда
			ВызватьИсключение "Не найдена номенклатура: " + Операция.FuelName;
		КонецЕсли;
		
		// 1. Создание документа "Реализация товаров"
		ДокументРеализация = Документы.РеализацияТоваров.СоздатьДокумент();
		ДокументРеализация.Дата = ДатаДокумента;
		ДокументРеализация.Контрагент = Контрагент;
		ДокументРеализация.ДоговорВзаиморасчетов = Настройки.ДоговорРозничныйПоУмолчанию;
		ДокументРеализация.Организация = Настройки.Организация;
		ДокументРеализация.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
		ДокументРеализация.СкладКомпании = Настройки.СкладКомпании;
		ДокументРеализация.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643"); // RUB
		ДокументРеализация.КурсДокумента = 1;
		ДокументРеализация.ХозОперация = Перечисления.ХозОперации.РеализацияТоваров;
		ДокументРеализация.РегламентированныйУчет = Истина;
		ДокументРеализация.ЭтоУниверсальныйДокумент = Истина;
		ДокументРеализация.СпособЗачетаАвансов = Перечисления.СпособыЗачетаАвансов.НеЗачитывать;
		ДокументРеализация.ТипЦен = Настройки.ТипЦен;
		ДокументРеализация.Менеджер = Настройки.МенеджерПоУмолчанию;
		
		// Заполнение табличной части "Товары"
		НоваяСтрока = ДокументРеализация.Товары.Добавить();
		НоваяСтрока.Номенклатура = Номенклатура;
		НоваяСтрока.Количество = Операция.Volume;
		НоваяСтрока.Цена = Операция.OrigPrice;
		НоваяСтрока.Сумма = Операция.Amount;
		НоваяСтрока.СтавкаНДС = Перечисления.СтавкиНДС.НДС20;
		НоваяСтрока.СуммаНДС = ЗагрузкаТОПАЗОбщий.РассчитатьСуммуНДС(Операция.Amount, 20);
		НоваяСтрока.СуммаСНДС = Операция.Amount;
		
		ДокументРеализация.Записать(РежимЗаписиДокумента.Проведение);
		
		// 2. Создание документа "Чек на оплату"
		ДокументЧек = Документы.ЧекНаОплату.СоздатьДокумент();
		ДокументЧек.Дата = ДатаДокумента;
		ДокументЧек.ДокументОснование = ДокументРеализация.Ссылка;
		ДокументЧек.Контрагент = Контрагент;
		ДокументЧек.ДоговорВзаиморасчетов = Настройки.ДоговорРозничныйПоУмолчанию;
		ДокументЧек.Организация = Настройки.Организация;
		ДокументЧек.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
		ДокументЧек.КассаККМ = Настройки.КассаККМ;
		ДокументЧек.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
		ДокументЧек.ХозОперация = Перечисления.ХозОперации.ЧекНаОплату;
		ДокументЧек.РегламентированныйУчет = Истина;
		ДокументЧек.СтавкаНДС = Перечисления.СтавкиНДС.НДС20;
		ДокументЧек.БлокироватьПерерасчетСкидок = Истина;
		ДокументЧек.ПризнакСпособаРасчета = Перечисления.ПризнакиСпособаРасчета.ПередачаСПолнойОплатой;
		ДокументЧек.Сделка = ДокументРеализация.Ссылка;
		
		// Копирование табличной части "Товары"
		Для Каждого СтрокаТовара Из ДокументРеализация.Товары Цикл
			НоваяСтрокаЧека = ДокументЧек.Товары.Добавить();
			НоваяСтрокаЧека.Номенклатура = СтрокаТовара.Номенклатура;
			НоваяСтрокаЧека.Количество = СтрокаТовара.Количество;
			НоваяСтрокаЧека.Цена = СтрокаТовара.Цена;
			НоваяСтрокаЧека.Сумма = СтрокаТовара.Сумма;
			НоваяСтрокаЧека.СтавкаНДС = СтрокаТовара.СтавкаНДС;
			НоваяСтрокаЧека.СуммаНДС = СтрокаТовара.СуммаНДС;
		КонецЦикла;
		
		// Заполнение табличной части "Оплаты"
		ДанныеОплаты = ЗагрузкаТОПАЗОбщий.ОпределитьСпособОплаты(Операция.AmountCash, Операция.AmountCashless);
		
		Если ДанныеОплаты.СпособОплаты <> Неопределено Тогда
			НоваяОплата = ДокументЧек.Оплаты.Добавить();
			НоваяОплата.СпособОплаты = ДанныеОплаты.СпособОплаты;
			НоваяОплата.Сумма = ДанныеОплаты.Сумма;
		КонецЕсли;
		
		Если ДанныеОплаты.Свойство("СпособОплаты2") И ДанныеОплаты.СпособОплаты2 <> Неопределено Тогда
			НоваяОплата2 = ДокументЧек.Оплаты.Добавить();
			НоваяОплата2.СпособОплаты = ДанныеОплаты.СпособОплаты2;
			НоваяОплата2.Сумма = ДанныеОплаты.Сумма2;
		КонецЕсли;
		
		ДокументЧек.Записать(РежимЗаписиДокумента.Проведение);
		
		// 3. Создание документа "Инкассация"
		ДокументИнкассация = Документы.Инкассация.СоздатьДокумент();
		ДокументИнкассация.Дата = ДатаДокумента;
		ДокументИнкассация.ДокументОснование = ДокументЧек.Ссылка;
		ДокументИнкассация.Организация = Настройки.Организация;
		ДокументИнкассация.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
		ДокументИнкассация.КассаККМ = Настройки.КассаККМ;
		ДокументИнкассация.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
		ДокументИнкассация.СуммаДокумента = Операция.Amount;
		ДокументИнкассация.ХозОперация = Перечисления.ХозОперации.ИзъятиеИзКассыККМ;
		ДокументИнкассация.Инкассатор = Настройки.Инкассатор;
		ДокументИнкассация.ДоговорВзаиморасчетовИнкассатор = Настройки.ДоговорИнкассации;
		ДокументИнкассация.ПлатежнаяСистема = Настройки.ПлатежнаяСистема;
		ДокументИнкассация.ДоговорВзаиморасчетовПлатежнаяСистема = Настройки.ДоговорПлатежнойСистемы;
		
		// Копирование табличной части "Оплаты"
		Для Каждого СтрокаОплаты Из ДокументЧек.Оплаты Цикл
			НоваяОплатаИнкассации = ДокументИнкассация.Оплаты.Добавить();
			НоваяОплатаИнкассации.СпособОплаты = СтрокаОплаты.СпособОплаты;
			НоваяОплатаИнкассации.Сумма = СтрокаОплаты.Сумма;
		КонецЦикла;
		
		ДокументИнкассация.Записать(РежимЗаписиДокумента.Проведение);
		
		// 4. Создание документа "Приходный кассовый ордер" (только для наличных)
		Если Операция.AmountCash > 0 Тогда
			
			ДокументПКО = Документы.ПриходныйКассовыйОрдер.СоздатьДокумент();
			ДокументПКО.Дата = ДатаДокумента;
			ДокументПКО.ДокументОснование = ДокументИнкассация.Ссылка;
			ДокументПКО.Организация = Настройки.Организация;
			ДокументПКО.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
			ДокументПКО.КассаКомпании = Настройки.КассаКомпании;
			ДокументПКО.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
			ДокументПКО.СуммаДокумента = Операция.AmountCash;
			ДокументПКО.ХозОперация = Перечисления.ХозОперации.ИнкассацияИзКассыККМ;
			ДокументПКО.РегламентированныйУчет = Истина;
			ДокументПКО.Контрагент = Настройки.Инкассатор;
			ДокументПКО.ДоговорВзаиморасчетов = Настройки.ДоговорИнкассации;
			ДокументПКО.ВидОперации = Перечисления.ВидыОпераций.Инкассация;
			
			ДокументПКО.Записать(РежимЗаписиДокумента.Проведение);
			
		КонецЕсли;
		
		// 5. Создание документа "Счет-фактура выданный"
		ДокументСчетФактура = Документы.СчетФактураВыданный.СоздатьДокумент();
		ДокументСчетФактура.Дата = ДатаДокумента;
		ДокументСчетФактура.ДокументОснование = ДокументРеализация.Ссылка;
		ДокументСчетФактура.Контрагент = Контрагент;
		ДокументСчетФактура.ДоговорВзаиморасчетов = Настройки.ДоговорРозничныйПоУмолчанию;
		ДокументСчетФактура.Организация = Настройки.Организация;
		ДокументСчетФактура.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
		ДокументСчетФактура.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
		ДокументСчетФактура.ВидСчетаФактуры = Перечисления.ВидыСчетовФактур.НаРеализацию;
		ДокументСчетФактура.РегламентированныйУчет = Истина;
		
		// Копирование табличной части "Товары"
		Для Каждого СтрокаТовара Из ДокументРеализация.Товары Цикл
			НоваяСтрокаСФ = ДокументСчетФактура.Товары.Добавить();
			НоваяСтрокаСФ.Номенклатура = СтрокаТовара.Номенклатура;
			НоваяСтрокаСФ.Количество = СтрокаТовара.Количество;
			НоваяСтрокаСФ.Цена = СтрокаТовара.Цена;
			НоваяСтрокаСФ.Сумма = СтрокаТовара.Сумма;
			НоваяСтрокаСФ.СтавкаНДС = СтрокаТовара.СтавкаНДС;
			НоваяСтрокаСФ.СуммаНДС = СтрокаТовара.СуммаНДС;
		КонецЦикла;
		
		ДокументСчетФактура.Записать(РежимЗаписиДокумента.Проведение);
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		ВызватьИсключение;
		
	КонецПопытки;
	
КонецПроцедуры

// Создает документы для операций по топливным картам
//
// Параметры:
//  Операция - Структура - данные операции
//  ДатаДокумента - Дата - дата создания документов
//  Настройки - Структура - настройки загрузки
//  ДанныеСессии - Структура - данные сессии
//
Процедура СоздатьДокументыТопливныхКарт(Операция, ДатаДокумента, Настройки, ДанныеСессии)
	
	НачатьТранзакцию();
	
	Попытка
		
		// Поиск контрагента по ИНН
		Контрагент = ЗагрузкаТОПАЗОбщий.НайтиКонтрагентаПоИНН(Строка(Операция.PartnerINN));
		
		Если Контрагент = Неопределено Тогда
			ВызватьИсключение "Не найден контрагент с ИНН: " + Строка(Операция.PartnerINN);
		КонецЕсли;
		
		// Поиск договора контрагента
		Договор = ЗагрузкаТОПАЗОбщий.НайтиДоговорКонтрагента(Контрагент);
		
		Если Договор = Неопределено Тогда
			ВызватьИсключение "Не найден договор для контрагента: " + Контрагент;
		КонецЕсли;
		
		// Поиск номенклатуры
		Номенклатура = ЗагрузкаТОПАЗОбщий.НайтиНоменклатуруПоНаименованию(Операция.FuelName);
		
		Если Номенклатура = Неопределено Тогда
			ВызватьИсключение "Не найдена номенклатура: " + Операция.FuelName;
		КонецЕсли;
		
		// Формирование комментария
		Комментарий = "Топливная карта: " + Строка(Операция.CardCode);
		Если Не ПустаяСтрока(Строка(Операция.LimitCard_CarName)) Тогда
			Комментарий = Комментарий + ", Автомобиль: " + Строка(Операция.LimitCard_CarName);
		КонецЕсли;
		Если Не ПустаяСтрока(Строка(Операция.LimitCard_CarNumber)) Тогда
			Комментарий = Комментарий + " " + Строка(Операция.LimitCard_CarNumber);
		КонецЕсли;
		
		// 1. Создание документа "Реализация товаров"
		ДокументРеализация = Документы.РеализацияТоваров.СоздатьДокумент();
		ДокументРеализация.Дата = ДатаДокумента;
		ДокументРеализация.Контрагент = Контрагент;
		ДокументРеализация.ДоговорВзаиморасчетов = Договор;
		ДокументРеализация.Организация = Настройки.Организация;
		ДокументРеализация.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
		ДокументРеализация.СкладКомпании = Настройки.СкладКомпании;
		ДокументРеализация.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
		ДокументРеализация.ХозОперация = Перечисления.ХозОперации.РеализацияТоваров;
		ДокументРеализация.РегламентированныйУчет = Истина;
		ДокументРеализация.СпособЗачетаАвансов = Перечисления.СпособыЗачетаАвансов.НеЗачитывать;
		ДокументРеализация.ТипЦен = Настройки.ТипЦен;
		ДокументРеализация.Менеджер = Настройки.МенеджерПоУмолчанию;
		ДокументРеализация.Комментарий = Комментарий;
		
		// Заполнение табличной части "Товары"
		НоваяСтрока = ДокументРеализация.Товары.Добавить();
		НоваяСтрока.Номенклатура = Номенклатура;
		НоваяСтрока.Количество = Операция.Volume;
		НоваяСтрока.Цена = Операция.OrigPrice;
		НоваяСтрока.Сумма = Операция.Amount;
		
		// Определение ставки НДС по номенклатуре
		СтавкаНДС = 20; // По умолчанию
		Если Номенклатура.СтавкаНДС <> Неопределено Тогда
			СтавкаНДС = Номенклатура.СтавкаНДС;
		КонецЕсли;
		
		НоваяСтрока.СтавкаНДС = СтавкаНДС;
		НоваяСтрока.СуммаНДС = ЗагрузкаТОПАЗОбщий.РассчитатьСуммуНДС(Операция.Amount, СтавкаНДС);
		НоваяСтрока.СуммаСНДС = Операция.Amount;
		
		ДокументРеализация.Записать(РежимЗаписиДокумента.Проведение);
		
		// 2. Создание документа "Счет-фактура выданный"
		ДокументСчетФактура = Документы.СчетФактураВыданный.СоздатьДокумент();
		ДокументСчетФактура.Дата = ДатаДокумента;
		ДокументСчетФактура.ДокументОснование = ДокументРеализация.Ссылка;
		ДокументСчетФактура.Контрагент = Контрагент;
		ДокументСчетФактура.ДоговорВзаиморасчетов = Договор;
		ДокументСчетФактура.Организация = Настройки.Организация;
		ДокументСчетФактура.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
		ДокументСчетФактура.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
		ДокументСчетФактура.ВидСчетаФактуры = Перечисления.ВидыСчетовФактур.НаРеализацию;
		ДокументСчетФактура.РегламентированныйУчет = Истина;
		
		// Копирование табличной части "Товары"
		Для Каждого СтрокаТовара Из ДокументРеализация.Товары Цикл
			НоваяСтрокаСФ = ДокументСчетФактура.Товары.Добавить();
			НоваяСтрокаСФ.Номенклатура = СтрокаТовара.Номенклатура;
			НоваяСтрокаСФ.Количество = СтрокаТовара.Количество;
			НоваяСтрокаСФ.Цена = СтрокаТовара.Цена;
			НоваяСтрокаСФ.Сумма = СтрокаТовара.Сумма;
			НоваяСтрокаСФ.СтавкаНДС = СтрокаТовара.СтавкаНДС;
			НоваяСтрокаСФ.СуммаНДС = СтрокаТовара.СуммаНДС;
		КонецЦикла;
		
		ДокументСчетФактура.Записать(РежимЗаписиДокумента.Проведение);
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		ВызватьИсключение;
		
	КонецПопытки;
	
КонецПроцедуры

// Обрабатывает последний день месяца: создает итоговые документы и помечает на удаление промежуточные
//
// Параметры:
//  Настройки - Структура - настройки загрузки
//
Процедура ОбработатьПоследнийДеньМесяца(Настройки)
	
	ТекущаяДата = ТекущаяДата();
	НачалоМесяца = НачалоДня(НачалоМесяца(ТекущаяДата));
	КонецМесяца = КонецДня(КонецМесяца(ТекущаяДата));
	
	// Поиск всех документов "Реализация товаров" по топливным картам за текущий месяц
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	РеализацияТоваров.Ссылка КАК Ссылка,
	|	РеализацияТоваров.Контрагент КАК Контрагент,
	|	РеализацияТоваров.Дата КАК Дата
	|ИЗ
	|	Документ.РеализацияТоваров КАК РеализацияТоваров
	|ГДЕ
	|	РеализацияТоваров.Дата МЕЖДУ &НачалоМесяца И &КонецМесяца
	|	И РеализацияТоваров.Контрагент <> &ЧастноеЛицо
	|	И РеализацияТоваров.ПометкаУдаления = ЛОЖЬ
	|	И РеализацияТоваров.Проведен = ИСТИНА";
	
	ЧастноеЛицо = ЗагрузкаТОПАЗОбщий.НайтиКонтрагентаЧастноеЛицо();
	
	Запрос.УстановитьПараметр("НачалоМесяца", НачалоМесяца);
	Запрос.УстановитьПараметр("КонецМесяца", КонецМесяца);
	Запрос.УстановитьПараметр("ЧастноеЛицо", ЧастноеЛицо);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	// Группировка по контрагенту и номенклатуре
	Группы = Новый Соответствие;
	
	Пока Выборка.Следующий() Цикл
		
		ДокументРеализации = Выборка.Ссылка.ПолучитьОбъект();
		Контрагент = Выборка.Контрагент;
		
		Для Каждого СтрокаТовара Из ДокументРеализации.Товары Цикл
			
			КлючГруппы = Строка(Контрагент) + "|" + Строка(СтрокаТовара.Номенклатура);
			
			Если Не Группы.Получить(КлючГруппы) Тогда
				Группа = Новый Структура;
				Группа.Вставить("Контрагент", Контрагент);
				Группа.Вставить("Номенклатура", СтрокаТовара.Номенклатура);
				Группа.Вставить("Количество", 0);
				Группа.Вставить("Сумма", 0);
				Группа.Вставить("СуммаСЦеной", 0); // для расчета средневзвешенной цены
				Группа.Вставить("Документы", Новый Массив);
				Группы.Вставить(КлючГруппы, Группа);
			КонецЕсли;
			
			Группа = Группы.Получить(КлючГруппы);
			Группа.Количество = Группа.Количество + СтрокаТовара.Количество;
			Группа.Сумма = Группа.Сумма + СтрокаТовара.Сумма;
			Группа.СуммаСЦеной = Группа.СуммаСЦеной + (СтрокаТовара.Количество * СтрокаТовара.Цена);
			
			Если Группа.Документы.Найти(Выборка.Ссылка) = Неопределено Тогда
				Группа.Документы.Добавить(Выборка.Ссылка);
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;
	
	// Создание итоговых документов для каждой группы
	Для Каждого ЭлементГруппы Из Группы Цикл
		
		Группа = ЭлементГруппы.Значение;
		
		НачатьТранзакцию();
		
		Попытка
			
			// Поиск договора контрагента
			Договор = ЗагрузкаТОПАЗОбщий.НайтиДоговорКонтрагента(Группа.Контрагент);
			
			Если Договор = Неопределено Тогда
				ВызватьИсключение "Не найден договор для контрагента: " + Группа.Контрагент;
			КонецЕсли;
			
			// Расчет средневзвешенной цены
			СредневзвешеннаяЦена = 0;
			Если Группа.Количество > 0 Тогда
				СредневзвешеннаяЦена = Группа.СуммаСЦеной / Группа.Количество;
			КонецЕсли;
			
			// Определение ставки НДС
			СтавкаНДС = 20; // По умолчанию
			Если Группа.Номенклатура.СтавкаНДС <> Неопределено Тогда
				СтавкаНДС = Группа.Номенклатура.СтавкаНДС;
			КонецЕсли;
			
			// Создание итогового документа "Реализация товаров"
			ДатаИтоговогоДокумента = КонецМесяца;
			ДатаИтоговогоДокумента = НачалоДня(ДатаИтоговогоДокумента) + Время(23, 59, 0);
			
			ДокументРеализация = Документы.РеализацияТоваров.СоздатьДокумент();
			ДокументРеализация.Дата = ДатаИтоговогоДокумента;
			ДокументРеализация.Контрагент = Группа.Контрагент;
			ДокументРеализация.ДоговорВзаиморасчетов = Договор;
			ДокументРеализация.Организация = Настройки.Организация;
			ДокументРеализация.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
			ДокументРеализация.СкладКомпании = Настройки.СкладКомпании;
			ДокументРеализация.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
			ДокументРеализация.ХозОперация = Перечисления.ХозОперации.РеализацияТоваров;
			ДокументРеализация.РегламентированныйУчет = Истина;
			ДокументРеализация.СпособЗачетаАвансов = Перечисления.СпособыЗачетаАвансов.НеЗачитывать;
			ДокументРеализация.ТипЦен = Настройки.ТипЦен;
			ДокументРеализация.Менеджер = Настройки.МенеджерПоУмолчанию;
			
			Месяц = Формат(ТекущаяДата, "ДФ=MMMM");
			Год = Год(ТекущаяДата);
			ДокументРеализация.Комментарий = "Итоговая реализация за " + Месяц + " " + Год;
			
			// Заполнение табличной части "Товары"
			НоваяСтрока = ДокументРеализация.Товары.Добавить();
			НоваяСтрока.Номенклатура = Группа.Номенклатура;
			НоваяСтрока.Количество = Группа.Количество;
			НоваяСтрока.Цена = СредневзвешеннаяЦена;
			НоваяСтрока.Сумма = Группа.Сумма;
			НоваяСтрока.СтавкаНДС = СтавкаНДС;
			НоваяСтрока.СуммаНДС = ЗагрузкаТОПАЗОбщий.РассчитатьСуммуНДС(Группа.Сумма, СтавкаНДС);
			НоваяСтрока.СуммаСНДС = Группа.Сумма;
			
			ДокументРеализация.Записать(РежимЗаписиДокумента.Проведение);
			
			// Создание итогового "Счет-фактура выданный"
			ДокументСчетФактура = Документы.СчетФактураВыданный.СоздатьДокумент();
			ДокументСчетФактура.Дата = ДатаИтоговогоДокумента;
			ДокументСчетФактура.ДокументОснование = ДокументРеализация.Ссылка;
			ДокументСчетФактура.Контрагент = Группа.Контрагент;
			ДокументСчетФактура.ДоговорВзаиморасчетов = Договор;
			ДокументСчетФактура.Организация = Настройки.Организация;
			ДокументСчетФактура.ПодразделениеКомпании = Настройки.ПодразделениеКомпании;
			ДокументСчетФактура.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
			ДокументСчетФактура.ВидСчетаФактуры = Перечисления.ВидыСчетовФактур.НаРеализацию;
			ДокументСчетФактура.РегламентированныйУчет = Истина;
			
			// Копирование табличной части "Товары"
			Для Каждого СтрокаТовара Из ДокументРеализация.Товары Цикл
				НоваяСтрокаСФ = ДокументСчетФактура.Товары.Добавить();
				НоваяСтрокаСФ.Номенклатура = СтрокаТовара.Номенклатура;
				НоваяСтрокаСФ.Количество = СтрокаТовара.Количество;
				НоваяСтрокаСФ.Цена = СтрокаТовара.Цена;
				НоваяСтрокаСФ.Сумма = СтрокаТовара.Сумма;
				НоваяСтрокаСФ.СтавкаНДС = СтрокаТовара.СтавкаНДС;
				НоваяСтрокаСФ.СуммаНДС = СтрокаТовара.СуммаНДС;
			КонецЦикла;
			
			ДокументСчетФактура.Записать(РежимЗаписиДокумента.Проведение);
			
			// Пометить на удаление все исходные документы за месяц
			Для Каждого СсылкаДокумента Из Группа.Документы Цикл
				
				ДокументДляУдаления = СсылкаДокумента.ПолучитьОбъект();
				ДокументДляУдаления.УстановитьПометкуУдаления(Истина);
				ДокументДляУдаления.Записать();
				
				// Поиск и пометка на удаление соответствующих счетов-фактур
				ЗапросСФ = Новый Запрос;
				ЗапросСФ.Текст = 
				"ВЫБРАТЬ ПЕРВЫЕ 1
				|	СчетФактураВыданный.Ссылка КАК Ссылка
				|ИЗ
				|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
				|ГДЕ
				|	СчетФактураВыданный.ДокументОснование = &ДокументОснование
				|	И СчетФактураВыданный.ПометкаУдаления = ЛОЖЬ";
				
				ЗапросСФ.УстановитьПараметр("ДокументОснование", СсылкаДокумента);
				РезультатСФ = ЗапросСФ.Выполнить();
				ВыборкаСФ = РезультатСФ.Выбрать();
				
				Пока ВыборкаСФ.Следующий() Цикл
					ДокументСФ = ВыборкаСФ.Ссылка.ПолучитьОбъект();
					ДокументСФ.УстановитьПометкуУдаления(Истина);
					ДокументСФ.Записать();
				КонецЦикла;
				
			КонецЦикла;
			
			ЗафиксироватьТранзакцию();
			
		Исключение
			
			ОтменитьТранзакцию();
			ТекстОшибки = ОписаниеОшибки();
			ЗаписьЖурналаРегистрации("ЗагрузкаТОПАЗ", 
				УровеньЖурналаРегистрации.Ошибка, , , 
				"Ошибка при создании итоговых документов для контрагента " + Группа.Контрагент + ": " + ТекстОшибки);
			
		КонецПопытки;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

# Расширение конфигурации "1С:Альфа-Авто 6.1" для загрузки данных из ТОПАЗ

## Описание

Расширение предназначено для автоматизированной загрузки данных о реализации топлива из системы ТОПАЗ в 1С:Альфа-Авто 6.1 с автоматическим формированием документов учета.

### Основные возможности

- Автоматическая загрузка данных из XML файлов ТОПАЗ
- Обработка розничных операций (наличный и безналичный расчет)
- Обработка операций по топливным картам
- Автоматическое формирование документов:
  - Реализация товаров
  - Чек на оплату
  - Инкассация
  - Приходный кассовый ордер (для наличных)
  - Счет-фактура выданный
- Автоматический запуск ежедневно в 23:50
- Возможность ручного запуска загрузки

---

## Требования

- Конфигурация: 1С:Альфа-Авто 6.1
- Формат файлов: XML (кодировка Windows-1251)
- Имя файла: `CloseSession_ГГГГ-ММ-ДД_ЧЧ-ММ-СС.xml` или `CloseSession_ГГГГ-ММ-ДД*.xml`
- Версия формата ТОПАЗ: 3.15

---

## Настройка перед тестированием

### 1. Заполнение регистра сведений "Настройки загрузки ТОПАЗ"

**Путь:** Регистры сведений → Настройки загрузки ТОПАЗ

**Обязательные настройки:**

| Поле | Описание | Пример |
|------|----------|--------|
| **Организация** | Организация для документов | Авангард |
| **Подразделение компании** | Подразделение для документов | Авангард |
| **Склад компании** | Склад для реализации | КПГ |
| **Касса ККМ** | Касса контрольно-кассовой машины | Касса Авангард |
| **Касса компании** | Главная касса компании | Касса (RUB) |
| **Договор розничный по умолчанию** | Договор для розничных операций | Розничная продажа |
| **Тип цен** | Тип цен для документов | Основной тип цен продажи |
| **Менеджер по умолчанию** | Менеджер для документов | (любой сотрудник) |
| **Инкассатор** | Контрагент-инкассатор | (контрагент) |
| **Договор инкассации** | Договор для инкассации | Инкассация АВ в RUB |
| **Платежная система** | Контрагент-платежная система | БАНК РУССКИЙ СТАНДАРТ АО |
| **Договор платежной системы** | Договор с платежной системой | Терминал АВ |
| **Каталог загрузки** | Путь к каталогу с XML файлами | `C:\ТОПАЗ\Выгрузка\` |

**Важно:** Все поля должны быть заполнены, иначе загрузка не запустится.

### 2. Проверка наличия справочников

Убедитесь, что в базе данных существуют:

- **Контрагенты:**
  - Контрагент с наименованием "Частное Лицо" (для розничных операций)
  - Контрагенты с заполненным ИНН (для операций по топливным картам)
  
- **Номенклатура:**
  - Номенклатура с наименованиями, соответствующими `FuelName` из XML файлов (например, "КПГ", "АИ-95" и т.д.)

- **Договоры взаиморасчетов:**
  - Договоры для контрагентов с топливными картами

### 3. Подготовка тестовых XML файлов

Создайте каталог для загрузки (например, `C:\ТОПАЗ\Выгрузка\`) и поместите туда тестовые XML файлы.

**Формат имени файла:** `CloseSession_2024-01-15_23-50-00.xml` или `CloseSession_2024-01-15*.xml`

---

## Инструкции по тестированию

### Тест 1: Ручной запуск загрузки

**Цель:** Проверить возможность ручного запуска загрузки и обработку розничных операций.

**Шаги:**

1. Откройте обработку **"Загрузка данных из ТОПАЗ"**
   - Путь: Обработки → Загрузка данных из ТОПАЗ

2. Убедитесь, что в каталоге загрузки есть XML файл за текущую дату

3. Нажмите кнопку **"Выполнить загрузку"** (если есть форма) или запустите обработку

4. Проверьте результат:
   - Должно появиться сообщение об успешной обработке
   - Проверьте журнал регистрации (Сервис → Журнал регистрации) на наличие записей

**Что проверить после загрузки:**

- ✅ Созданы документы "Реализация товаров"
- ✅ Созданы документы "Чек на оплату"
- ✅ Созданы документы "Инкассация"
- ✅ Для наличных операций созданы документы "Приходный кассовый ордер"
- ✅ Созданы документы "Счет-фактура выданный"
- ✅ Все документы проведены
- ✅ Суммы в документах соответствуют данным из XML

### Тест 2: Обработка розничных операций (наличный расчет)

**Цель:** Проверить создание документов для наличных операций.

**Подготовка:**

1. Создайте XML файл с операцией розничной продажи (наличный расчет)
2. В XML должен быть блок `OutcomeByRetail` с `PaymentModeName` ≠ "Топливная карта"
3. Установите `AmountCash > 0` и `AmountCashless = 0`

**Шаги:**

1. Поместите XML файл в каталог загрузки
2. Запустите обработку вручную
3. Проверьте созданные документы

**Ожидаемый результат:**

- Создан документ "Реализация товаров" с контрагентом "Частное Лицо"
- Создан документ "Чек на оплату" со способом оплаты "Наличными"
- Создан документ "Инкассация"
- Создан документ "Приходный кассовый ордер"
- Создан документ "Счет-фактура выданный"

### Тест 3: Обработка розничных операций (безналичный расчет)

**Цель:** Проверить создание документов для безналичных операций.

**Подготовка:**

1. Создайте XML файл с операцией розничной продажи (безналичный расчет)
2. Установите `AmountCash = 0` и `AmountCashless > 0`

**Ожидаемый результат:**

- Создан документ "Реализация товаров"
- Создан документ "Чек на оплату" со способом оплаты "Платежной картой"
- Создан документ "Инкассация" с указанием платежной системы
- **НЕ создан** документ "Приходный кассовый ордер" (только для наличных)
- Создан документ "Счет-фактура выданный"

### Тест 4: Обработка операций по топливным картам

**Цель:** Проверить создание документов для операций по топливным картам.

**Подготовка:**

1. Создайте XML файл с операцией по топливной карте
2. В XML должен быть блок `OutcomeByOffice` с `PaymentModeName = "Топливная карта"`
3. Обязательно заполните `PartnerINN` (ИНН контрагента)
4. Убедитесь, что контрагент с таким ИНН существует в базе

**Ожидаемый результат:**

- Создан документ "Реализация товаров" с контрагентом из справочника (по ИНН)
- Создан документ "Счет-фактура выданный"
- **НЕ созданы** документы "Чек на оплату" и "Инкассация" (только для розницы)

### Тест 5: Обработка смешанной оплаты (наличные + безналичные)

**Цель:** Проверить обработку операций с двумя способами оплаты.

**Подготовка:**

1. Создайте XML файл с операцией, где `AmountCash > 0` и `AmountCashless > 0`

**Ожидаемый результат:**

- Создан документ "Чек на оплату" с двумя строками в табличной части "Оплаты":
  - Строка 1: Способ оплаты "Наличными", сумма = AmountCash
  - Строка 2: Способ оплаты "Платежной картой", сумма = AmountCashless

### Тест 6: Автоматический запуск (регламентное задание)

**Цель:** Проверить работу автоматического запуска.

**Шаги:**

1. Убедитесь, что регламентное задание "Загрузка данных из ТОПАЗ" включено
   - Путь: Администрирование → Регламентные задания
   - Проверьте, что задание активно и расписание установлено на 23:50

2. Поместите XML файл в каталог загрузки

3. Дождитесь времени запуска или запустите задание вручную (если возможно)

**Ожидаемый результат:**

- Загрузка выполнилась автоматически
- В журнале регистрации есть записи о выполнении

### Тест 7: Обработка ошибок

**Цель:** Проверить обработку различных ошибок.

**Тестовые сценарии:**

1. **Отсутствие настроек:**
   - Очистите регистр сведений "Настройки загрузки ТОПАЗ"
   - Запустите загрузку
   - **Ожидаемый результат:** Сообщение об ошибке "Настройки загрузки не заполнены"

2. **Несуществующий каталог:**
   - Укажите несуществующий путь в настройках
   - Запустите загрузку
   - **Ожидаемый результат:** Сообщение об ошибке при попытке найти файлы

3. **Отсутствие контрагента:**
   - Создайте XML с топливной картой, где ИНН не существует в базе
   - Запустите загрузку
   - **Ожидаемый результат:** Ошибка в журнале регистрации, операция пропущена, остальные обработаны

4. **Отсутствие номенклатуры:**
   - Создайте XML с `FuelName`, которого нет в справочнике номенклатуры
   - Запустите загрузку
   - **Ожидаемый результат:** Ошибка в журнале регистрации, операция пропущена

---

## Проверка результатов загрузки

### 1. Проверка документов

После выполнения загрузки проверьте созданные документы:

**Документы → Реализация товаров:**
- Фильтр по дате загрузки
- Проверьте количество, суммы, контрагентов

**Документы → Чек на оплату:**
- Проверьте связь с документом "Реализация товаров"
- Проверьте способы оплаты и суммы

**Документы → Инкассация:**
- Проверьте суммы и способы оплаты

**Документы → Приходный кассовый ордер:**
- Проверьте наличие только для наличных операций

**Документы → Счет-фактура выданный:**
- Проверьте связь с документом "Реализация товаров"

### 2. Проверка журнала регистрации

**Путь:** Сервис → Журнал регистрации

**Фильтр:** Событие = "ЗагрузкаТОПАЗ"

**Что проверить:**

- ✅ Есть записи об успешной обработке файлов
- ✅ Нет критических ошибок (только предупреждения о пропущенных операциях)
- ✅ Записи содержат понятные сообщения

### 3. Проверка сумм и количеств

Сравните данные из XML файлов с созданными документами:

- Объемы (`Volume`) соответствуют количеству в документах
- Суммы (`Amount`) соответствуют суммам в документах
- Цены (`OrigPrice`) соответствуют ценам в документах
- НДС рассчитан корректно (20% от суммы с НДС)

---

## Пример структуры XML файла

```xml
<?xml version="1.0" encoding="windows-1251"?>
<DataPaket Version="3.15" DateTime="2024-01-15T23:50:00" Type="Aggregated" AZSCode="001">
    <Session SessionNum="123" StartDateTime="2024-01-15T08:00:00" 
             EndDateTime="2024-01-15T23:50:00" UserName="Оператор"/>
    
    <!-- Розничная продажа (наличный расчет) -->
    <OutcomeByRetail>
        <Item TankNum="1" HoseName="1" FuelName="КПГ" 
              PaymentModeName="Наличный расчет" Volume="50.5" 
              Amount="2500.00" OrigPrice="49.50" 
              AmountCash="2500.00" AmountCashless="0" OrderCount="5"/>
    </OutcomeByRetail>
    
    <!-- Розничная продажа (безналичный расчет) -->
    <OutcomeByRetail>
        <Item TankNum="1" HoseName="2" FuelName="КПГ" 
              PaymentModeName="Платежная карта" Volume="30.0" 
              Amount="1485.00" OrigPrice="49.50" 
              AmountCash="0" AmountCashless="1485.00" OrderCount="3"/>
    </OutcomeByRetail>
    
    <!-- Продажа по топливной карте -->
    <OutcomeByOffice>
        <Item Date="2024-01-15" Time="10:30:00" TankNum="1" 
              HoseName="3" FuelName="КПГ" PaymentModeName="Топливная карта" 
              Volume="100.0" Amount="4950.00" OrigPrice="49.50" AmountTotal="4950.00">
            <CardCode>1234567890</CardCode>
            <PartnerName>ООО "Компания"</PartnerName>
            <PartnerINN>123456789012</PartnerINN>
            <LimitCard_CarName>Газель</LimitCard_CarName>
            <LimitCard_CarNumber>А123БВ777</LimitCard_CarNumber>
        </Item>
    </OutcomeByOffice>
</DataPaket>
```

---

## Возможные проблемы и решения

### Проблема: "Настройки загрузки не заполнены"

**Решение:** Заполните все обязательные поля в регистре сведений "Настройки загрузки ТОПАЗ"

### Проблема: "Не найден контрагент 'Частное Лицо'"

**Решение:** Создайте контрагента с наименованием "Частное Лицо" в справочнике "Контрагенты"

### Проблема: "Не найдена номенклатура: [наименование]"

**Решение:** 
- Проверьте наименование топлива в XML (`FuelName`)
- Создайте номенклатуру с таким же наименованием в справочнике "Номенклатура"

### Проблема: "Не найден контрагент с ИНН: [ИНН]"

**Решение:** 
- Проверьте ИНН в XML (`PartnerINN`)
- Создайте контрагента с таким ИНН или исправьте ИНН в XML

### Проблема: "Не найден договор для контрагента"

**Решение:** Создайте договор взаиморасчетов для контрагента с топливной картой

### Проблема: Файлы не обрабатываются

**Решение:**
- Проверьте путь к каталогу загрузки в настройках
- Убедитесь, что файлы имеют правильное имя: `CloseSession_ГГГГ-ММ-ДД*.xml`
- Проверьте права доступа к каталогу

### Проблема: Документы не проводятся

**Решение:**
- Проверьте настройки документов (обязательные поля)
- Проверьте права пользователя на проведение документов
- Проверьте журнал регистрации на наличие ошибок

---

## Контакты для вопросов

При возникновении проблем или вопросов обращайтесь к разработчику расширения.

---

## Дополнительная информация

Подробное техническое задание находится в файле `ТЕХНИЧЕСКОЕ ЗАДАНИЕ.md`.
